<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
body {font-family: Arial,sans-serif;margin:0;padding:0;background:#f0f0f0;}
#admin-container {padding:15px;max-width:900px;margin:0 auto;transition:filter 0.3s,opacity 0.3s;}
body.protected #admin-container {filter:blur(8px);pointer-events:none;opacity:0.7;}
#login-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:9999;}
.login-box {background:white;padding:30px;border-radius:12px;text-align:center;width:90%;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.login-box h2 {margin-bottom:20px;color:#d40000;}
.login-box input {width:100%;padding:12px;margin:12px 0;border:1px solid #ccc;border-radius:6px;font-size:16px;box-sizing:border-box;}
.login-box button {width:100%;padding:12px;background:#d40000;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer;}
.login-error {color:#e74c3c;margin-top:10px;font-weight:bold;}
h1,h2 {color:#d40000;}
.section {background:white;padding:16px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input,select,textarea {width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:4px;font-size:14px;box-sizing:border-box;}
button {padding:8px 14px;margin:4px 4px 4px 0;border:none;border-radius:4px;cursor:pointer;font-size:14px;}
.add-btn {background:#d40000;color:white;}
.save-btn {background:#4CAF50;color:white;}
.delete-btn {background:#f44336;color:white;}
.item-preview {display:flex;gap:10px;padding:10px;border:1px solid #eee;border-radius:6px;margin:8px 0;align-items:flex-start;}
.item-img {width:60px;height:60px;object-fit:cover;border-radius:6px;}
.status {padding:8px;margin:10px 0;border-radius:4px;display:none;}
.success {background:#d4edda;color:#155724;display:block;}
.error {background:#f8d7da;color:#721c24;display:block;}
label {display:inline-block;margin-right:10px;margin-top:6px;}
.bulk-url-section {margin-top:12px;}
.bulk-url-section label {display:block;margin-bottom:4px;font-weight:bold;}
.file-input { margin-top: 8px; }
.menu-bulk-section {
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
}
.menu-bulk-section textarea {
  height: 150px;
  font-family: monospace;
}
</style>
</head>
<body class="protected">

<div id="login-overlay">
  <div class="login-box">
    <h2>üîê Admin Login</h2>
    <input type="password" id="password-input" placeholder="Enter password" autocomplete="off" />
    <button onclick="window.attemptLogin()">Login</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<div id="admin-container">
<h1>üõ†Ô∏è Content Admin Panel</h1>

<div class="section">
<h2>üìÅ Categories</h2>
<div>
<input type="text" id="catName" placeholder="Category Name">
<input type="url" id="catImage" placeholder="Image URL">
<button class="add-btn" id="addCategoryBtn">Add Category</button>
<button class="save-btn" id="exportCategoriesBtn" style="margin-left:10px;">üì• Export Categories (CSV)</button>
</div>

<div class="bulk-url-section">
  <label for="bulkUrls">üì• Bulk Category Images (One URL per line or comma-separated)</label>
  <textarea id="bulkUrls" rows="4" placeholder="https://example.com/cat1.jpg&#10;https://example.com/cat2.jpg&#10;..."></textarea>
  <button class="add-btn" id="bulkUrlUploadBtn">Create Categories from URLs</button>
  <small style="display:block;margin-top:4px;color:#666;">
    üí° Tip: Copy-paste from Excel column ‚Äî URLs only.
  </small>
</div>

<div id="categoriesList"></div>
</div>

<div class="section">
<h2>üç≤ Menu Items</h2>
<div>
<input type="text" id="itemName" placeholder="Item Name">
<input type="number" id="itemPrice" placeholder="Selling Price (‚Çπ)" min="0" step="0.01">
<input type="number" id="itemMrp" placeholder="MRP (‚Çπ)" min="0" step="0.01">
<input type="url" id="itemImage" placeholder="Image URL">
<select id="itemCategory"><option value="">-- Select Category --</option></select>
<label><input type="checkbox" id="itemOffer"> Offer Item</label>
<button class="add-btn" id="addMenuItemBtn">Add Menu Item</button>
</div>

<!-- BULK MENU UPLOAD -->
<div class="menu-bulk-section">
  <h3>Bulk Menu Item Upload</h3>
  <label for="bulkMenuItems">Paste menu items in this format:</label>
  <textarea id="bulkMenuItems" placeholder="Item Name | Price | MRP | Image URL | Category | Offer (true/false)&#10;Burger | 120 | 150 | https://example.com/burger.jpg | Fast Food | true&#10;Pizza | 250 | 300 | https://example.com/pizza.jpg | Italian | false"></textarea>
  <button class="add-btn" id="bulkMenuUploadBtn">Create Menu Items from Data</button>
  <small style="display:block;margin-top:8px;color:#666;">
    üí° Format: Name | Price | MRP | Image URL | Category | Offer<br>
    MRP can be empty if same as price. Offer is optional (default: false).
  </small>
</div>

<div id="menuList"></div>
</div>

<div class="section">
<h2>üéÅ Offers</h2>
<div>
<input type="text" id="offerTitle" placeholder="Offer Title">
<input type="text" id="offerDesc" placeholder="Description">
<label><input type="checkbox" id="offerActive" checked> Active</label>
<button class="add-btn" id="addOfferBtn">Add Offer</button>
</div>
<div id="offersList"></div>
</div>

<div id="status"></div>
</div>

<!-- ‚úÖ CORRECTED FIREBASE CDN URLs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script type="module">
  // Mock config for demonstration - in real app, this would come from config.js
  const config = {
    firebase: {
      apiKey: "AIzaSyDUMMY_KEY",
      authDomain: "dummy-project.firebaseapp.com",
      databaseURL: "https://dummy-project-default-rtdb.firebaseio.com",
      projectId: "dummy-project",
      storageBucket: "dummy-project.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456789"
    },
    adminPassword: "admin123"
  };
  
  const ADMIN_PASSWORD = config.adminPassword;

  // Initialize Firebase
  try {
    firebase.initializeApp(config.firebase);
    const db = firebase.database();
    let categories = [];

    let editMode = { type: null, key: null };

    // --- Login ---
    window.attemptLogin = function() {
      const input = document.getElementById('password-input').value;
      const errorEl = document.getElementById('login-error');
      if (input === ADMIN_PASSWORD) {
        document.body.classList.remove('protected');
        document.getElementById('login-overlay').style.display = 'none';
        loadAllData();
      } else {
        errorEl.textContent = "‚ùå Incorrect password";
        setTimeout(() => errorEl.textContent = "", 2000);
      }
    };

    // --- Status ---
    function showStatus(msg, isSuccess) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = isSuccess ? 'success' : 'error';
      setTimeout(() => el.textContent = '', 5000);
    }

    // --- Load Categories for Dropdown ---
    function loadCategoriesForDropdown() {
      db.ref('categories').once('value').then(snap => {
        categories = snap.val() ? Object.values(snap.val()) : [];
        const select = document.getElementById('itemCategory');
        select.innerHTML = '<option value="">-- Select Category --</option>';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.name;
          opt.textContent = cat.name;
          select.appendChild(opt);
        });
      });
    }

    // --- EXPORT CATEGORIES (CSV) ---
    function exportCategoriesToCSV() {
      db.ref('categories').once('value').then(snap => {
        const data = snap.val();
        if (!data) return showStatus('No categories.', false);
        let csv = 'Category Name,Image URL\n';
        csv += Object.values(data).map(cat => `"${cat.name.replace(/"/g, '""')}","${cat.image}"`).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'categories.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    // --- Reset Form ---
    function resetMenuItemForm() {
      document.getElementById('itemName').value = '';
      document.getElementById('itemPrice').value = '';
      document.getElementById('itemMrp').value = '';
      document.getElementById('itemImage').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemOffer').checked = false;
      document.getElementById('addMenuItemBtn').textContent = 'Add Menu Item';
    }

    // --- Menu Item Handler ---
    document.getElementById('addMenuItemBtn').addEventListener('click', function () {
      const name = document.getElementById('itemName').value.trim();
      const price = parseFloat(document.getElementById('itemPrice').value);
      const mrp = parseFloat(document.getElementById('itemMrp').value) || null;
      const image = document.getElementById('itemImage').value.trim();
      const category = document.getElementById('itemCategory').value;
      const offer = document.getElementById('itemOffer').checked;

      if (!name || isNaN(price) || !image || !category) {
        return showStatus('Name, price, image, and category required.', false);
      }

      const updateData = { name, price, image, category, offer };
      if (mrp && mrp > price) updateData.mrp = mrp;

      if (editMode.type === 'menu' && editMode.key) {
        db.ref('menu/' + editMode.key).update(updateData).then(() => {
          showStatus('Menu item updated!', true);
          resetMenuItemForm();
          editMode = { type: null, key: null };
          loadAllData();
        }).catch(err => showStatus(`‚ùå Update failed: ${err.message}`, false));
      } else {
        updateData.id = name.toLowerCase().replace(/\s+/g, '-');
        db.ref('menu').push(updateData).then(() => {
          showStatus('Menu item added!', true);
          resetMenuItemForm();
          loadAllData();
        }).catch(err => showStatus(`‚ùå Add failed: ${err.message}`, false));
      }
    });

    // --- Category Handler ---
    document.getElementById('addCategoryBtn').addEventListener('click', () => {
      const name = document.getElementById('catName').value.trim();
      const image = document.getElementById('catImage').value.trim();
      if (!name || !image) return showStatus('Name and image required.', false);

      if (editMode.type === 'category' && editMode.key) {
        db.ref('categories/' + editMode.key).update({ name, image }).then(() => {
          showStatus('Category updated!', true);
          document.getElementById('catName').value = '';
          document.getElementById('catImage').value = '';
          document.getElementById('addCategoryBtn').textContent = 'Add Category';
          editMode = { type: null, key: null };
          loadAllData();
        }).catch(err => showStatus(`‚ùå Update failed: ${err.message}`, false));
      } else {
        db.ref('categories').push({ name, image }).then(() => {
          showStatus('Category added!', true);
          document.getElementById('catName').value = '';
          document.getElementById('catImage').value = '';
          loadAllData();
        }).catch(err => showStatus(`‚ùå Add failed: ${err.message}`, false));
      }
    });

    // --- Offer Handler ---
    document.getElementById('addOfferBtn').addEventListener('click', () => {
      const title = document.getElementById('offerTitle').value.trim();
      const desc = document.getElementById('offerDesc').value.trim();
      const active = document.getElementById('offerActive').checked;
      if (!title || !desc) return showStatus('Title and description required.', false);

      if (editMode.type === 'offer' && editMode.key) {
        db.ref('offers/' + editMode.key).update({ title, description: desc, active }).then(() => {
          showStatus('Offer updated!', true);
          document.getElementById('offerTitle').value = '';
          document.getElementById('offerDesc').value = '';
          document.getElementById('offerActive').checked = true;
          document.getElementById('addOfferBtn').textContent = 'Add Offer';
          editMode = { type: null, key: null };
          loadAllData();
        }).catch(err => showStatus(`‚ùå Update failed: ${err.message}`, false));
      } else {
        db.ref('offers').push({ title, description: desc, active }).then(() => {
          showStatus('Offer added!', true);
          document.getElementById('offerTitle').value = '';
          document.getElementById('offerDesc').value = '';
          document.getElementById('offerActive').checked = true;
          loadAllData();
        }).catch(err => showStatus(`‚ùå Add failed: ${err.message}`, false));
      }
    });

    // --- Bulk Category from URLs ---
    document.getElementById('bulkUrlUploadBtn').addEventListener('click', async () => {
      const textarea = document.getElementById('bulkUrls');
      let text = textarea.value.trim();
      if (!text) return showStatus('‚ö†Ô∏è Enter image URLs.', false);
      let urls = text.split(/[\n,]+/).map(u => u.trim()).filter(u => u && /^https?:\/\//i.test(u));
      if (urls.length === 0) return showStatus('‚ö†Ô∏è No valid URLs.', false);
      showStatus(`üì§ Creating ${urls.length} categories...`, true);
      try {
        await Promise.all(urls.map((url, idx) => db.ref('categories').push({ name: `Untitled ${idx + 1}`, image: url })));
        showStatus(`‚úÖ ${urls.length} categories created!`, true);
        textarea.value = '';
        loadAllData();
      } catch (err) {
        showStatus(`‚ùå Failed: ${err.message}`, false);
      }
    });

    // --- Bulk Menu Items Upload ---
    document.getElementById('bulkMenuUploadBtn').addEventListener('click', async () => {
      const textarea = document.getElementById('bulkMenuItems');
      let text = textarea.value.trim();
      if (!text) return showStatus('‚ö†Ô∏è Enter menu items data.', false);
      
      // Get current categories for validation
      const categoriesSnap = await db.ref('categories').once('value');
      const validCategories = new Set(
        categoriesSnap.val() ? Object.values(categoriesSnap.val()).map(c => c.name) : []
      );
      
      if (validCategories.size === 0) {
        return showStatus('‚ùå No categories exist! Create categories first.', false);
      }
      
      // Parse the input
      const lines = text.split('\n').filter(line => line.trim() !== '');
      const items = [];
      const errors = [];
      
      for (let i = 0; i < lines.length; i++) {
        const parts = lines[i].split('|').map(part => part.trim());
        if (parts.length < 4) {
          errors.push(`Line ${i+1}: Invalid format. Expected: Name|Price|MRP|Image URL|Category|Offer`);
          continue;
        }
        
        const [name, priceStr, mrpStr, imageUrl, category, offerStr] = parts;
        
        // Validate required fields
        if (!name || !priceStr || !imageUrl || !category) {
          errors.push(`Line ${i+1}: Missing required field`);
          continue;
        }
        
        // Validate price
        const price = parseFloat(priceStr);
        if (isNaN(price)) {
          errors.push(`Line ${i+1}: Invalid price`);
          continue;
        }
        
        // Validate MRP (optional)
        let mrp = null;
        if (mrpStr && mrpStr !== '') {
          mrp = parseFloat(mrpStr);
          if (isNaN(mrp)) {
            errors.push(`Line ${i+1}: Invalid MRP`);
            continue;
          }
        }
        
        // Validate category
        if (!validCategories.has(category)) {
          errors.push(`Line ${i+1}: Invalid category "${category}"`);
          continue;
        }
        
        // Validate image URL
        if (!/^https?:\/\//i.test(imageUrl)) {
          errors.push(`Line ${i+1}: Invalid image URL`);
          continue;
        }
        
        // Validate offer (optional, default false)
        const offer = offerStr?.toLowerCase() === 'true';
        
        items.push({
          name,
          price,
          ...(mrp !== null && mrp > price ? { mrp } : {}),
          image: imageUrl,
          category,
          offer,
          id: name.toLowerCase().replace(/\s+/g, '-')
        });
      }
      
      if (items.length === 0) {
        return showStatus(`‚ùå No valid items. Check errors.`, false);
      }
      
      showStatus(`üì§ Uploading ${items.length} menu item(s)...`, true);
      try {
        const pushPromises = items.map(item => db.ref('menu').push(item));
        await Promise.all(pushPromises);
        
        let msg = `‚úÖ ${items.length} menu item(s) imported!`;
        if (errors.length) {
          msg += `\n‚ö†Ô∏è ${errors.length} skipped.`;
          console.warn('Import errors:', errors);
        }
        showStatus(msg, true);
        textarea.value = '';
        loadAllData();
      } catch (err) {
        console.error('Bulk menu upload error:', err);
        showStatus(`‚ùå Upload failed: ${err.message || 'Unknown error'}`, false);
      }
    });

    // --- Button Listeners ---
    document.getElementById('exportCategoriesBtn').addEventListener('click', exportCategoriesToCSV);

    // --- Load All Data ---
    function loadAllData() {
      loadCategoriesForDropdown();

      // Categories
      db.ref('categories').once('value').then(snap => {
        const list = document.getElementById('categoriesList');
        list.innerHTML = '<h3>Current Categories</h3>';
        const data = snap.val();
        if (!data) return list.innerHTML += '<p>None</p>';
        Object.entries(data).forEach(([key, item]) => {
          const div = document.createElement('div');
          div.className = 'item-preview';
          div.innerHTML = `<img class="item-img" src="${item.image}" onerror="this.src='https://via.placeholder.com/60'"/>
            <div>
              <strong>${item.name}</strong><br>
              <button class="save-btn" onclick="window.editCategory('${key}', '${item.name.replace(/'/g, "\\'")}', '${item.image.replace(/'/g, "\\'")}')">Edit</button>
              <button class="delete-btn" onclick="window.deleteItem('categories','${key}')">Delete</button>
            </div>`;
          list.appendChild(div);
        });
      });

      // Menu
      db.ref('menu').once('value').then(snap => {
        const list = document.getElementById('menuList');
        list.innerHTML = '<h3>Current Menu Items</h3>';
        const data = snap.val();
        if (!data) return list.innerHTML += '<p>None</p>';
        Object.entries(data).forEach(([key, item]) => {
          let priceInfo = `‚Çπ${item.price}`;
          if (item.mrp && item.mrp > item.price) {
            const disc = Math.round(((item.mrp - item.price) / item.mrp) * 100);
            priceInfo = `<del>‚Çπ${item.mrp}</del> ‚Çπ${item.price} (${disc}% OFF)`;
          }
          const div = document.createElement('div');
          div.className = 'item-preview';
          div.innerHTML = `<img class="item-img" src="${item.image}" onerror="this.src='https://via.placeholder.com/60'"/>
            <div>
              <strong>${item.name}</strong> ‚Äî ${priceInfo} (${item.category}) ${item.offer ? 'üî•' : ''}<br>
              <button class="save-btn" onclick="window.editMenuItem('${key}', \`${item.name.replace(/`/g, '\\`')}\`, ${item.price}, ${item.mrp || 'null'}, \`${item.image.replace(/`/g, '\\`')}\`, \`${item.category.replace(/`/g, '\\`')}\`, ${item.offer})">Edit</button>
              <button class="delete-btn" onclick="window.deleteItem('menu','${key}')">Delete</button>
            </div>`;
          list.appendChild(div);
        });
      });

      // Offers
      db.ref('offers').once('value').then(snap => {
        const list = document.getElementById('offersList');
        list.innerHTML = '<h3>Current Offers</h3>';
        const data = snap.val();
        if (!data) return list.innerHTML += '<p>None</p>';
        Object.entries(data).forEach(([key, item]) => {
          const div = document.createElement('div');
          div.className = 'item-preview';
          div.innerHTML = `<div>
            <strong>${item.title}</strong> ‚Äî ${item.description} ${item.active ? 'üü¢' : 'üî¥'}<br>
            <button class="save-btn" onclick="window.editOffer('${key}', \`${item.title.replace(/`/g, '\\`')}\`, \`${item.description.replace(/`/g, '\\`')}\`, ${item.active})">Edit</button>
            <button class="delete-btn" onclick="window.deleteItem('offers','${key}')">Delete</button>
          </div>`;
          list.appendChild(div);
        });
      });
    }

    // --- Edit Functions ---
    window.editCategory = function(key, name, image) {
      document.getElementById('catName').value = name;
      document.getElementById('catImage').value = image;
      document.getElementById('addCategoryBtn').textContent = 'Save Category';
      editMode = { type: 'category', key };
    };

    window.editMenuItem = function(key, name, price, mrp, image, category, offer) {
      document.getElementById('itemName').value = name;
      document.getElementById('itemPrice').value = price;
      document.getElementById('itemMrp').value = mrp || '';
      document.getElementById('itemImage').value = image;
      document.getElementById('itemCategory').value = category;
      document.getElementById('itemOffer').checked = offer;
      document.getElementById('addMenuItemBtn').textContent = 'Save Menu Item';
      editMode = { type: 'menu', key };
    };

    window.editOffer = function(key, title, desc, active) {
      document.getElementById('offerTitle').value = title;
      document.getElementById('offerDesc').value = desc;
      document.getElementById('offerActive').checked = active;
      document.getElementById('addOfferBtn').textContent = 'Save Offer';
      editMode = { type: 'offer', key };
    };

    window.deleteItem = function(type, key) {
      if (confirm('Delete?')) {
        db.ref(type + '/' + key).remove().then(() => {
          showStatus('Deleted!', true);
          loadAllData();
        }).catch(err => showStatus(`‚ùå Delete failed: ${err.message}`, false));
      }
    };
    
    // Initialize with login screen
    document.getElementById('login-overlay').style.display = 'flex';
  } catch (error) {
    console.error("Firebase initialization error:", error);
    document.getElementById('status').textContent = "Firebase initialization failed. Check console for details.";
    document.getElementById('status').className = "error";
  }
</script>
</body>
</html>
