<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firebase Image Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 1000px;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }
    h2, h3 {
      color: #1a73e8;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .folder-controls, .upload-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    input, select, button {
      padding: 8px 12px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    button.choose {
      background: #1a73e8;
      color: white;
    }
    button.upload {
      background: #4caf50;
      color: white;
    }
    button.create {
      background: #ff9800;
      color: white;
    }
    button.delete {
      background: #d32f2f;
      color: white;
      padding: 4px 8px;
      font-size: 12px;
    }
    button.copy {
      background: #388e3c;
      color: white;
      padding: 4px 8px;
      font-size: 12px;
    }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      background: #f0f4ff;
    }
    .drop-zone.highlight {
      border-color: #1a73e8;
      background: #e3f2fd;
    }
    .selected-files {
      margin: 10px 0;
      font-size: 0.9em;
      color: #555;
    }
    .image-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .image-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      width: 200px;
      text-align: center;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .image-card img {
      max-width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
    }
    .image-info {
      font-size: 0.75em;
      word-break: break-all;
      margin: 5px 0;
      color: #555;
    }
    .folder-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1a73e8;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 4px;
    }
    progress {
      width: 100%;
      display: none;
      margin-top: 10px;
    }
    .empty {
      color: #777;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>

  <h2>üìÅ Image Manager</h2>

  <!-- Folder Controls -->
  <div class="section">
    <div class="folder-controls">
      <label><strong>Folder:</strong></label>
      <select id="folderSelect">
        <option value="">Root</option>
      </select>
      <input type="text" id="newFolderInput" placeholder="New folder name" />
      <button class="create" id="createFolderBtn">Create Folder</button>
    </div>
  </div>

  <!-- Upload Section -->
  <div class="section drop-zone" id="dropZone">
    <p>üìÅ Drag & drop images here</p>
    <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" />
    <button class="choose" id="chooseBtn">Choose Files</button>
    <div class="selected-files" id="selectedFiles">No files selected</div>
    <button class="upload" id="uploadBtn">üì§ Upload Selected Files</button>
    <progress id="uploadProgress" value="0" max="100"></progress>
  </div>

  <!-- Image List -->
  <h3>üñº Uploaded Images (<span id="currentFolderDisplay">Root</span>)</h3>
  <div id="imageGrid">
    <p class="empty">Loading images...</p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
      authDomain: "mirdhuna-25542.firebaseapp.com",
      databaseURL: "https://mirdhuna-25542-default-rtdb.firebaseio.com",
      projectId: "mirdhuna-25542",
      storageBucket: "mirdhuna-25542.firebasestorage.app",
      messagingSenderId: "575924409876",
      appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const storageRef = firebase.storage().ref();
    const imagesRef = firebase.database().ref("images");

    // DOM Elements
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const chooseBtn = document.getElementById("chooseBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const imageGrid = document.getElementById("imageGrid");
    const folderSelect = document.getElementById("folderSelect");
    const createFolderBtn = document.getElementById("createFolderBtn");
    const newFolderInput = document.getElementById("newFolderInput");
    const currentFolderDisplay = document.getElementById("currentFolderDisplay");
    const selectedFiles = document.getElementById("selectedFiles");

    let selectedFilesList = [];
    let currentFolder = "";

    // =============== Choose Files ===============
    chooseBtn.onclick = () => fileInput.click();
    fileInput.addEventListener("change", () => {
      const files = Array.from(fileInput.files).filter(f => f.type.startsWith("image/"));
      selectedFilesList = files;
      selectedFiles.textContent = `Selected: ${files.length} image(s)`;
    });

    // =============== Drag & Drop ===============
    ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => {
      dropZone.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    dropZone.addEventListener("dragover", () => dropZone.classList.add("highlight"));
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("highlight"));
    dropZone.addEventListener("drop", (e) => {
      dropZone.classList.remove("highlight");
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
      selectedFilesList = files;
      selectedFiles.textContent = `Selected: ${files.length} image(s)`;
    });

    // =============== Create Folder ===============
    createFolderBtn.addEventListener("click", () => {
      const name = newFolderInput.value.trim();
      if (!name) return alert("Folder name is required");
      if (/[.#$\/\[\]]/.test(name)) return alert("Invalid characters: .#$[]/");

      if (!Array.from(folderSelect.options).some(opt => opt.value === name)) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        folderSelect.appendChild(opt);
      }
      newFolderInput.value = "";
    });

    // =============== Folder Change ===============
    folderSelect.addEventListener("change", () => {
      currentFolder = folderSelect.value;
      currentFolderDisplay.textContent = currentFolder || "Root";
      loadImages();
    });

    // =============== Upload Files ===============
    uploadBtn.addEventListener("click", () => {
      if (selectedFilesList.length === 0) {
        alert("Please select at least one image");
        return;
      }

      uploadProgress.style.display = "block";
      uploadProgress.value = 0;

      const total = selectedFilesList.length;
      let uploaded = 0;

      selectedFilesList.forEach(file => {
        const timestamp = new Date().getTime();
        const folderPath = currentFolder ? `${currentFolder}/` : "";
        const filePath = `images/${folderPath}${timestamp}_${file.name}`;
        const fileRef = storageRef.child(filePath);

        const task = fileRef.put(file);

        task.on("state_changed",
          (snap) => {
            const percent = (snap.bytesTransferred / snap.totalBytes) * 100;
            uploadProgress.value = ((uploaded * 100) + percent) / total;
          },
          (error) => {
            console.error("Upload failed:", error);
            alert(`Failed: ${file.name}`);
          },
          () => {
            task.snapshot.ref.getDownloadURL().then(url => {
              const newImageRef = imagesRef.push();
              newImageRef.set({
                id: newImageRef.key,
                name: file.name,
                url: url,
                path: filePath,
                folder: currentFolder,
                uploadedAt: firebase.database.ServerValue.TIMESTAMP
              }).then(() => {
                uploaded++;
                if (uploaded === total) {
                  uploadProgress.style.display = "none";
                  selectedFilesList = [];
                  fileInput.value = "";
                  selectedFiles.textContent = "No files selected";
                  loadImages();
                  alert("‚úÖ All images uploaded!");
                }
              });
            });
          }
        );
      });
    });

    // =============== Load Folders ===============
    function loadFolders() {
      imagesRef.once("value", (snapshot) => {
        const data = snapshot.val();
        const folders = new Set();

        if (data) {
          Object.values(data).forEach(img => {
            const path = img.path || "";
            const match = path.match(/^images\/([^/]+)/);
            if (match) folders.add(match[1]);
          });
        }

        folderSelect.innerHTML = '<option value="">Root</option>';
        Array.from(folders).sort().forEach(folder => {
          const opt = document.createElement("option");
          opt.value = folder;
          opt.textContent = folder;
          folderSelect.appendChild(opt);
        });

        if (folderSelect.querySelector(`option[value="${currentFolder}"]`)) {
          folderSelect.value = currentFolder;
        } else {
          currentFolder = "";
          folderSelect.value = "";
        }
        currentFolderDisplay.textContent = currentFolder || "Root";
      });
    }

    // =============== Load Images ===============
    function loadImages() {
      imageGrid.innerHTML = '<p>Loading images...</p>';

      imagesRef.once("value", (snapshot) => {
        const data = snapshot.val();
        imageGrid.innerHTML = "";

        if (!data) {
          imageGrid.innerHTML = '<p class="empty">No images found</p>';
          return;
        }

        const items = Object.values(data).filter(img => {
          if (!currentFolder) return !((img.path || "").includes("/"));
          return (img.path || "").startsWith(`images/${currentFolder}/`);
        }).sort((a, b) => (b.uploadedAt || 0) - (a.uploadedAt || 0));

        if (items.length === 0) {
          imageGrid.innerHTML = '<p class="empty">No images in this folder</p>';
          return;
        }

        items.forEach(img => {
          const card = document.createElement("div");
          card.className = "image-card";

          const folderLabel = img.folder ? `<span class="folder-tag">${img.folder}</span>` : "üìÅ Root";

          card.innerHTML = `
            <img src="${img.url}" alt="${img.name}" onerror="this.src='https://via.placeholder.com/200x150?text=Image+Not+Found';" />
            <div class="image-info">${img.name}</div>
            ${folderLabel}
            <button class="copy" data-url="${img.url}">üìã Copy URL</button>
            <button class="delete" data-id="${img.id}" data-path="${img.path}">üóë Delete</button>
          `;

          imageGrid.appendChild(card);
        });

        // Copy URL
        document.querySelectorAll(".copy").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const url = e.target.dataset.url;
            navigator.clipboard.writeText(url).then(() => {
              alert("‚úÖ URL copied!");
            }).catch(() => prompt("Copy URL:", url));
          });
        });

        // Delete
        document.querySelectorAll(".delete").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const id = e.target.dataset.id;
            const path = e.target.dataset.path;

            if (!confirm("Delete this image permanently?")) return;

            // Delete from Firebase Storage
            storageRef.child(path).delete()
              .then(() => console.log("‚úÖ Deleted from Storage"))
              .catch(err => {
                if (err.code === 'storage/object-not-found') {
                  console.log("File already deleted or not found");
                } else {
                  console.error("Storage delete error:", err);
                }
              });

            // Delete from Realtime Database
            imagesRef.orderByChild("id").equalTo(id).once("value", snap => {
              snap.forEach(child => {
                child.ref.remove()
                  .then(() => {
                    alert("‚úÖ Deleted successfully");
                    loadImages();
                    loadFolders();
                  })
                  .catch(err => {
                    alert("‚ùå Failed to delete from database: " + err.message);
                  });
              });
            });
          });
        });
      });
    }

    // =============== Initialize ===============
    loadFolders();
    loadImages();
  </script>

</body>
</html>
