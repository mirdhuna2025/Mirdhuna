<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar: #1e293b;
            --header: #ffffff;
            --card: #ffffff;
            --text: #333333;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f1f5f9;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--sidebar);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            color: #cbd5e1;
            text-decoration: none;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid var(--success);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #d1146a;
        }

        /* Content Area */
        .content {
            padding: 30px;
        }

        .card {
            background: var(--card);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--dark);
        }

        .card-body {
            padding: 20px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-print {
            background: var(--info);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .stat-icon.orders {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .stat-icon.revenue {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .stat-icon.views {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
        }

        .stat-icon.users {
            background: rgba(72, 149, 239, 0.1);
            color: var(--info);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #64748b;
            margin: 0;
        }

        /* Login Form */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark);
        }

        .error-message {
            color: var(--danger);
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        /* Blur effect for content when not logged in */
        .blur-content {
            filter: blur(10px);
            pointer-events: none;
        }

        /* Upload Previews */
        .upload-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            display: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar-menu a span {
                display: none;
            }
            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }
            .main-content {
                margin-left: 0;
            }
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>Admin Login</h2>
            <div class="error-message" id="errorMessage">Invalid password. Please try again.</div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
            </div>
            <button class="btn btn-submit" id="loginBtn">Login</button>
        </div>
    </div>

    <!-- Main Content (Blurred initially) -->
    <div class="container blur-content" id="mainContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Admin Panel</h3>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="#" class="active" data-target="dashboard"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a></li>
                    <li><a href="#" data-target="orders"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                    <li><a href="#" data-target="users"><i class="fas fa-users"></i> <span>User Login History</span></a></li>
                    <li><a href="#" data-target="slides"><i class="fas fa-images"></i> <span>Slide Management</span></a></li>
                    <li><a href="#" data-target="menu"><i class="fas fa-utensils"></i> <span>Menu Management</span></a></li>
                    <li><a href="#" data-target="analytics"><i class="fas fa-chart-bar"></i> <span>Analytics</span></a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Admin Dashboard</h1>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Content Sections -->
            <div class="content">
                <!-- Dashboard -->
                <div class="section active" id="dashboard">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon orders">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalOrders">0</h3>
                                <p>Total Orders</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon revenue">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalRevenue">₹0</h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon views">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayViews">0</h3>
                                <p>Today's Views</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Users</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Recent Orders</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Time</th>
                                            <th>Items</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersTable">
                                        <!-- Recent orders will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="section" id="orders" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Order History</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Time</th>
                                            <th>Items</th>
                                            <th>No. of Items</th>
                                            <th>Amount</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTable">
                                        <!-- Orders will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Login History -->
                <div class="section" id="users" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>User Login History</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <!-- Updated table header to include Location -->
                                <table>
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Login Time</th>
                                            <th>IP Address</th>
                                            <th>Device</th>
                                            <th>Location</th> <!-- Added Location column header -->
                                        </tr>
                                    </thead>
                                    <tbody id="userLoginTable">
                                        <!-- User login history will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide Management -->
                <div class="section" id="slides" style="display: none;">
  <div class="card">
    <div class="card-header">
      <h2>Slide Management</h2>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label for="slideImageUrl">Enter Slide Image URL</label>
        <input type="text" id="slideImageUrl" class="form-control" placeholder="Enter the full URL of the image (e.g., https://example.com/image.jpg)">
        <div id="slidePreview" style="margin-top:10px;"></div>
      </div>
      <button class="btn btn-submit" id="uploadSlideBtn">
        <i class="fas fa-link"></i> Add Slide
      </button>
      <div class="table-container" style="margin-top: 30px;">
        <table>
          <thead>
            <tr>
              <th>Slide</th>
              <th>Upload Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="slidesTable">
            <!-- Slides will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
                

                <!-- Menu Management -->
                <div class="section" id="menu" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Menu Management</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="itemName">Item Name</label>
                                <input type="text" id="itemName" class="form-control" placeholder="Enter item name">
                            </div>
                            <div class="form-group">
                                <label for="itemPrice">Price</label>
                                <input type="number" id="itemPrice" class="form-control" placeholder="Enter price">
                            </div>
                            <div class="form-group">
                                <label for="itemImageUrl">Item Image URL</label>
                                <input type="text" id="itemImageUrl" class="form-control" placeholder="Enter the full URL of the image (e.g., https://example.com/image.jpg)">
                            </div>
                            <!-- Hidden input to store the ID of the item being edited -->
                            <input type="hidden" id="editItemId" value="">
                            <button class="btn btn-submit" id="addItemBtn">
                                <i class="fas fa-plus"></i> <span id="addEditButtonText">Add Item</span>
                            </button>

                            <div class="table-container" style="margin-top: 30px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="menuTable">
                                        <!-- Menu items will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="section" id="analytics" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Analytics</h2>
                        </div>
                        <div class="card-body">
                            <div class="stats-container">
                                <div class="stat-card">
                                    <div class="stat-icon views">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3 id="todayViewsAnalytics">0</h3>
                                        <p>Today's Views</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon views">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3 id="totalViewsAnalytics">0</h3>
                                        <p>Total Views</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h2>View Statistics</h2>
                                </div>
                                <div class="card-body">
                                    <p>Note: Chart implementation requires additional libraries like Chart.js. This section shows data structure.</p>
                                    <div id="analyticsDataDisplay">
                                        <!-- Data will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCiG3Tal0dCpBAV1SLS2Rbs6GYOA4zomQE",
            authDomain: "mirdhuna-4f652.firebaseapp.com",
            databaseURL: "https://mirdhuna-4f652-default-rtdb.firebaseio.com",
            projectId: "mirdhuna-4f652",
            storageBucket: "mirdhuna-4f652.firebasestorage.app",
            messagingSenderId: "184403369330",
            appId: "1:184403369330:web:859bcf3162bc2d2ed7d1eb",
            measurementId: "G-ZFWSGKE744"
        };

        // Initialize Firebase
        console.log("Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        console.log("Firebase initialized successfully.");

        // --- DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM fully loaded and parsed. Setting up Admin Panel...");

            // Authentication Elements
            const correctPassword = "Sanu.0000";
            const loginContainer = document.getElementById('loginContainer');
            const mainContainer = document.getElementById('mainContainer');
            const adminPassword = document.getElementById('adminPassword');
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            const logoutBtn = document.getElementById('logoutBtn');

            // Check if already logged in
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                console.log("User already logged in.");
                loginContainer.style.display = 'none';
                mainContainer.classList.remove('blur-content');
            }

            loginBtn.addEventListener('click', function() {
                console.log("Login button clicked.");
                if (adminPassword.value === correctPassword) {
                    console.log("Password correct. Logging in...");
                    loginContainer.style.display = 'none';
                    mainContainer.classList.remove('blur-content');
                    localStorage.setItem('adminLoggedIn', 'true');
                } else {
                    console.log("Password incorrect.");
                    errorMessage.style.display = 'block';
                }
            });

            logoutBtn.addEventListener('click', function() {
                console.log("Logout button clicked.");
                localStorage.removeItem('adminLoggedIn');
                location.reload();
            });

            // Navigation
            const navLinks = document.querySelectorAll('.sidebar-menu a');
            const sections = document.querySelectorAll('.section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log(`Navigation link clicked: ${this.getAttribute('data-target')}`);

                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.style.display = 'none');

                    // Add active class to clicked link
                    this.classList.add('active');

                    // Show corresponding section
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).style.display = 'block';

                    // Load data for the section
                    loadDataForSection(target);
                });
            });

            // --- Firebase Interaction Functions ---

            // Load data for each section
            function loadDataForSection(section) {
                console.log(`Loading data for section: ${section}`);
                switch(section) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'orders':
                        loadOrdersData();
                        break;
                    case 'users':
                        loadUserLoginData();
                        break;
                    case 'slides':
                        loadSlidesData();
                        break;
                    case 'menu':
                        loadMenuData();
                        break;
                    case 'analytics':
                        loadAnalyticsData();
                        break;
                    default:
                        console.warn(`Unknown section: ${section}`);
                }
            }

            // Dashboard Data
            function loadDashboardData() {
                console.log("Loading Dashboard data...");
                // Load total orders
                const ordersRef = ref(database, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const orders = snapshot.val();
                    if (orders) {
                        const orderCount = Object.keys(orders).length;
                        document.getElementById('totalOrders').textContent = orderCount;

                        // Calculate total revenue
                        let totalRevenue = 0;
                        Object.values(orders).forEach(order => {
                            totalRevenue += order.amount || 0;
                        });
                        document.getElementById('totalRevenue').textContent = `₹${totalRevenue}`;

                        // Populate recent orders
                        const recentOrdersTable = document.getElementById('recentOrdersTable');
                        recentOrdersTable.innerHTML = '';

                        // Get last 5 orders
                        const orderEntries = Object.entries(orders);
                        const recentOrders = orderEntries.slice(-5);

                        recentOrders.forEach(([id, order]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${id}</td>
                                <td>${new Date(order.timestamp).toLocaleString()}</td>
                                <td>${order.items ? Object.keys(order.items).length : 0} items</td>
                                <td>₹${order.amount || 0}</td>
                                <td><span class="status ${order.status || 'pending'}">${order.status || 'Pending'}</span></td>
                            `;
                            recentOrdersTable.appendChild(row);
                        });
                    } else {
                         document.getElementById('totalOrders').textContent = '0';
                         document.getElementById('totalRevenue').textContent = '₹0';
                         document.getElementById('recentOrdersTable').innerHTML = '<tr><td colspan="5">No orders found</td></tr>';
                    }
                });

                // Load today's views
                const analyticsRef = ref(database, 'analytics');
                onValue(analyticsRef, (snapshot) => {
                    const analyticsData = snapshot.val();
                    const today = new Date().toISOString().split('T')[0];
                    let todayViews = 0;

                    if (analyticsData && analyticsData.pageViews && analyticsData.pageViews[today] !== undefined) {
                        todayViews = analyticsData.pageViews[today];
                    }
                    document.getElementById('todayViews').textContent = todayViews;
                });

                // Load total users
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const users = snapshot.val();
                    if (users) {
                        const userCount = Object.keys(users).length;
                        document.getElementById('totalUsers').textContent = userCount;
                    } else {
                        document.getElementById('totalUsers').textContent = '0';
                    }
                });
            }

            // Orders Data
            function loadOrdersData() {
                console.log("Loading Orders data...");
                const ordersRef = ref(database, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const orders = snapshot.val();
                    const ordersTable = document.getElementById('ordersTable');
                    ordersTable.innerHTML = '';

                    if (orders) {
                        Object.entries(orders).forEach(([id, order]) => {
                            // Calculate the total number of items
                            let totalItems = 0;
                            if (order.items && typeof order.items === 'object') {
                                Object.values(order.items).forEach(item => {
                                    totalItems += parseInt(item.quantity) || 0;
                                });
                            }

                            // Safely get the amount, default to 0 if not present
                            const amount = order.amount || 0;

                            // Create the row
                            const row = document.createElement('tr');
                            // Build the items list
                            let itemsList = '';
                            if (order.items && typeof order.items === 'object') {
                                itemsList = Object.values(order.items).map(item => 
                                    `${item.name} (x${item.quantity || 0})`
                                ).join(', ');
                            } else {
                                itemsList = 'No items';
                            }

                            // Populate the row with the correct data
                            row.innerHTML = `
                                <td>${id}</td>
                                <td>${new Date(order.timestamp).toLocaleString()}</td>
                                <td>${itemsList}</td>
                                <td>${totalItems}</td>
                                <td>₹${amount}</td>
                                <td>${order.location || 'N/A'}</td>
                                <td>
                                    <select class="status-select" data-order-id="${id}">
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-print" onclick="printOrder('${id}')">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteOrder('${id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            ordersTable.appendChild(row);
                        });

                        // Add event listeners for status changes
                        document.querySelectorAll('.status-select').forEach(select => {
                            select.addEventListener('change', function() {
                                const orderId = this.getAttribute('data-order-id');
                                const newStatus = this.value;
                                console.log(`Updating order ${orderId} status to ${newStatus}`);
                                update(ref(database, `orders/${orderId}`), {
                                    status: newStatus
                                }).catch(error => {
                                    console.error("Error updating order status:", error);
                                    alert("Failed to update order status: " + error.message);
                                });
                            });
                        });
                    } else {
                        ordersTable.innerHTML = '<tr><td colspan="8">No orders found</td></tr>';
                    }
                });
            }

            // User Login Data (Updated to handle Location)
            function loadUserLoginData() {
                console.log("Loading User Login data...");
                // Assuming user login history is stored under /users/$userId/loginHistory
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const users = snapshot.val();
                    const userLoginTable = document.getElementById('userLoginTable');
                    userLoginTable.innerHTML = ''; // Clear existing data

                    if (users) {
                        let hasLoginData = false;
                        Object.entries(users).forEach(([userId, userData]) => {
                            // Check if loginHistory exists for this user
                            if (userData && userData.loginHistory) {
                                hasLoginData = true;
                                Object.entries(userData.loginHistory).forEach(([loginId, loginDetails]) => {
                                    const row = document.createElement('tr');
                                    // Format timestamp if it exists
                                    let formattedTime = 'N/A';
                                    if (loginDetails.timestamp) {
                                        try {
                                            formattedTime = new Date(loginDetails.timestamp).toLocaleString();
                                        } catch (e) {
                                            console.warn(`Could not format timestamp for user ${userId}, login ${loginId}:`, loginDetails.timestamp);
                                            formattedTime = loginDetails.timestamp.toString(); // Fallback to raw string
                                        }
                                    }

                                    // Create table row with Location column
                                    row.innerHTML = `
                                        <td>${userId}</td>
                                        <td>${formattedTime}</td>
                                        <td>${loginDetails.ip || 'N/A'}</td>
                                        <td>${loginDetails.device || 'N/A'}</td>
                                        <td>${loginDetails.location || 'N/A'}</td> <!-- Added Location column -->
                                    `;
                                    userLoginTable.appendChild(row);
                                });
                            }
                        });
                        if (!hasLoginData) {
                             userLoginTable.innerHTML = '<tr><td colspan="5">No user login history found</td></tr>';
                        }
                    } else {
                        userLoginTable.innerHTML = '<tr><td colspan="5">No users found</td></tr>';
                    }
                }, (error) => {
                    console.error("Error loading user login ", error);
                    const userLoginTable = document.getElementById('userLoginTable');
                    if (userLoginTable) {
                        userLoginTable.innerHTML = `<tr><td colspan="5">Error loading  ${error.message}</td></tr>`;
                    }
                });
            }

            // Slides Data (Using URL instead of upload)
            function loadSlidesData() {
                console.log("Loading Slides data...");
                const slidesRef = ref(database, 'slides');
                onValue(slidesRef, (snapshot) => {
                    const slides = snapshot.val();
                    const slidesTable = document.getElementById('slidesTable');
                    slidesTable.innerHTML = '';

                    if (slides) {
                        Object.entries(slides).forEach(([id, slide]) => {
                            const row = document.createElement('tr');
                            // Use the stored URL from the database
                            row.innerHTML = `
                                <td><img src="${slide.url}" alt="Slide" style="width: 100px; height: 60px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/100x60?text=Image+Not+Found';"></td>
                                <td>${new Date(slide.timestamp).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-delete" onclick="deleteSlide('${id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            `;
                            slidesTable.appendChild(row);
                        });
                    } else {
                         slidesTable.innerHTML = '<tr><td colspan="3">No slides found</td></tr>';
                    }
                });

                // --- Add slide using URL ---
                const uploadSlideBtn = document.getElementById('uploadSlideBtn');
                const slideImageUrlInput = document.getElementById('slideImageUrl');

                if (uploadSlideBtn && slideImageUrlInput) {
                    console.log("Setting up Add Slide button listener.");
                    uploadSlideBtn.addEventListener('click', async function(event) {
                        event.preventDefault();
                        console.log("Add Slide button clicked.");
                        const imageUrl = slideImageUrlInput?.value.trim();

                        if (!imageUrl) {
                            alert('Please enter a valid image URL.');
                            return;
                        }

                        try {
                            // Save the URL and metadata to the Realtime Database
                            console.log("Saving slide data to Realtime Database...");
                            const newSlideRef = push(ref(database, 'slides'));
                            await set(newSlideRef, {
                                url: imageUrl,
                                timestamp: new Date().toISOString()
                            });
                            console.log('Slide data saved to Realtime Database successfully.');

                            // Reset form
                            slideImageUrlInput.value = '';
                            alert('Slide added successfully!');
                            // Reload data to show new slide
                            loadSlidesData();

                        } catch (error) {
                            console.error('Error in slide add process:', error);
                            alert(`Error adding slide: ${error.message}`);
                        }
                    });
                } else {
                    console.error("CRITICAL ERROR: Add Slide button or input field not found in DOM.");
                }
            }

            // Menu Data (Using URL instead of upload)
            function loadMenuData() {
                console.log("Loading Menu data...");
                const menuRef = ref(database, 'menu');
                onValue(menuRef, (snapshot) => {
                    const menu = snapshot.val();
                    const menuTable = document.getElementById('menuTable');
                    menuTable.innerHTML = '';

                    if (menu) {
                        Object.entries(menu).forEach(([id, item]) => {
                            const row = document.createElement('tr');
                            // Use the stored URL from the database
                            row.innerHTML = `
                                <td><img src="${item.image || 'https://via.placeholder.com/60?text=No+Image'}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=Image+Not+Found';"></td>
                                <td>${item.name}</td>
                                <td>₹${item.price}</td>
                                <td>
                                    <button class="btn btn-edit" onclick="editMenuItem('${id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteMenuItem('${id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            `;
                            menuTable.appendChild(row);
                        });
                    } else {
                        menuTable.innerHTML = '<tr><td colspan="4">No menu items found</td></tr>';
                    }
                });

                // --- Add/Update menu item with URL ---
                const addItemBtn = document.getElementById('addItemBtn');
                const itemNameInput = document.getElementById('itemName');
                const itemPriceInput = document.getElementById('itemPrice');
                const itemImageUrlInput = document.getElementById('itemImageUrl');
                const addEditButtonText = document.getElementById('addEditButtonText');
                const editItemIdInput = document.getElementById('editItemId');

                if (addItemBtn) {
                    console.log("Setting up Add Item button listener.");
                    addItemBtn.addEventListener('click', async function(event) {
                        event.preventDefault();
                        console.log("Add/Update Item button clicked.");

                        const name = itemNameInput?.value.trim();
                        const price = itemPriceInput?.value.trim();
                        const imageUrl = itemImageUrlInput?.value.trim();
                        const editItemId = editItemIdInput?.value;

                        if (!name || !price) {
                            alert('Please enter item name and price.');
                            return;
                        }

                        try {
                            // Determine if we are adding a new item or updating an existing one
                            if (editItemId) {
                                // Update existing item
                                console.log(`Updating existing menu item with ID: ${editItemId}`);
                                const itemRef = ref(database, `menu/${editItemId}`);

                                // Prepare the update data
                                const updateData = {
                                    name: name,
                                    price: parseFloat(price),
                                    timestamp: new Date().toISOString()
                                };

                                // Only update the image if a new URL was provided
                                if (imageUrl) {
                                    updateData.image = imageUrl;
                                }

                                await update(itemRef, updateData);
                                console.log('Menu item updated successfully.');

                                // Reset the form to "Add Item" mode
                                editItemIdInput.value = '';
                                addEditButtonText.textContent = 'Add Item';

                            } else {
                                // Add new item
                                console.log("Adding new menu item.");
                                const newItemRef = push(ref(database, 'menu'));
                                await set(newItemRef, {
                                    name: name,
                                    price: parseFloat(price),
                                    image: imageUrl, // Will be empty string if no URL
                                    timestamp: new Date().toISOString()
                                });
                                console.log('New menu item added successfully.');
                            }

                            // Reset form
                            if (itemNameInput) itemNameInput.value = '';
                            if (itemPriceInput) itemPriceInput.value = '';
                            if (itemImageUrlInput) itemImageUrlInput.value = '';
                            alert(`Menu item ${editItemId ? 'updated' : 'added'} successfully!`);
                            // Reload data to show changes
                            loadMenuData();

                        } catch (error) {
                            console.error('Error in menu item save process:', error);
                            alert(`Error ${editItemId ? 'updating' : 'adding'} menu item: ${error.message}`);
                        }
                    });
                } else {
                     console.error("CRITICAL ERROR: Add Item button (id='addItemBtn') not found in DOM.");
                }
            }

            // Function to handle editing a menu item
            window.editMenuItem = function(itemId) {
                console.log(`Edit Menu Item button clicked for ID: ${itemId}`);
                // Fetch the current item data from the database
                const itemRef = ref(database, `menu/${itemId}`);
                onValue(itemRef, (snapshot) => {
                    const item = snapshot.val();
                    if (item) {
                        // Populate the form with the current item's data
                        const itemNameInput = document.getElementById('itemName');
                        const itemPriceInput = document.getElementById('itemPrice');
                        const itemImageUrlInput = document.getElementById('itemImageUrl');
                        const editItemIdInput = document.getElementById('editItemId');
                        const addEditButtonText = document.getElementById('addEditButtonText');

                        if (itemNameInput) itemNameInput.value = item.name;
                        if (itemPriceInput) itemPriceInput.value = item.price;
                        if (itemImageUrlInput) itemImageUrlInput.value = item.image || '';
                        if (editItemIdInput) editItemIdInput.value = itemId;
                        if (addEditButtonText) addEditButtonText.textContent = 'Update Item';

                        // Optionally, scroll to the form
                        const menuSection = document.getElementById('menu');
                        menuSection?.scrollIntoView({ behavior: 'smooth' });

                    } else {
                        console.error(`Menu item with ID ${itemId} not found in database.`);
                        alert('Error: Menu item not found.');
                    }
                }, { onlyOnce: true }); // Only read once
            };

            // Analytics Data (Fixed Reading Logic)
            function loadAnalyticsData() {
                console.log("Loading Analytics data...");
                const analyticsRef = ref(database, 'analytics');
                onValue(analyticsRef, (snapshot) => {
                    // Get the raw data object
                    const analyticsData = snapshot.val();

                    // Get references to the HTML elements to update
                    const todayViewsElement = document.getElementById('todayViewsAnalytics');
                    const totalViewsElement = document.getElementById('totalViewsAnalytics');
                    const dataDisplayElement = document.getElementById('analyticsDataDisplay'); // For detailed view

                    // Get today's date string (YYYY-MM-DD)
                    const today = new Date().toISOString().split('T')[0];

                    // Check if data exists
                    if (analyticsData) {
                        // Try to get today's views, default to 0 if not found
                        const todayViews = (analyticsData.pageViews && analyticsData.pageViews[today]) ? analyticsData.pageViews[today] : 0;

                        // Try to get total views, default to 0 if not found
                        const totalViews = analyticsData.totalViews || 0;

                        // Update the HTML elements
                        if (todayViewsElement) todayViewsElement.textContent = todayViews;
                        if (totalViewsElement) totalViewsElement.textContent = totalViews;

                        // Display detailed data structure for debugging/viewing
                        if (dataDisplayElement) {
                            if (analyticsData.pageViews) {
                                let pageViewsHtml = '<h3>Page Views by Date:</h3><ul>';
                                for (const [date, count] of Object.entries(analyticsData.pageViews)) {
                                    pageViewsHtml += `<li>${date}: ${count} views</li>`;
                                }
                                pageViewsHtml += '</ul>';
                                dataDisplayElement.innerHTML = pageViewsHtml;
                            } else {
                                dataDisplayElement.innerHTML = '<p>No page view data available yet.</p>';
                            }
                        }

                    } else {
                        // Handle case where 'analytics' node doesn't exist at all
                        console.log("Analytics data not found in database.");
                        if (todayViewsElement) todayViewsElement.textContent = '0';
                        if (totalViewsElement) totalViewsElement.textContent = '0';
                        if (dataDisplayElement) dataDisplayElement.innerHTML = '<p>No analytics data found. Ensure your main website is sending analytics data.</p>';
                    }
                });
            }

            // --- Global functions for buttons ---
            window.printOrder = function(orderId) {
                console.log(`Print Order button clicked for ID: ${orderId}`);
                // Create a printable version of the order
                const printWindow = window.open('', '_blank');
                // Use a simple, narrow width suitable for thermal paper (e.g., 80mm)
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Order #${orderId}</title>
                            <style>
                                body { 
                                    font-family: 'Courier New', monospace; /* Monospace font for thermal printers */
                                    font-size: 12px; /* Smaller font size */
                                    width: 80mm; /* Typical thermal paper width */
                                    margin: 0 auto;
                                    padding: 5px;
                                }
                                .header, .footer { 
                                    text-align: center; 
                                    margin-bottom: 10px;
                                    font-weight: bold;
                                }
                                .order-details { 
                                    margin-bottom: 10px; 
                                }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    font-size: 12px;
                                }
                                th, td { 
                                    padding: 2px 0; 
                                    text-align: left; 
                                }
                                th { 
                                    border-bottom: 1px dashed #000; /* Dashed line for separation */
                                }
                                .total { 
                                    text-align: right; 
                                    margin-top: 10px; 
                                    font-weight: bold;
                                }
                                .order-id {
                                    font-size: 14px;
                                    font-weight: bold;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h2>** MIRDHUNA RESTAURANT **</h2> <!-- Your Brand Name -->
                                <p>123 Food Street, City</p> <!-- Your Address -->
                                <p>Phone: +91 XXXXXXXXXX</p> <!-- Your Phone -->
                            </div>
                            <div class="order-details">
                                <p><strong>Order ID:</strong> <span class="order-id">${orderId}</span></p>
                                <p><strong>Date:</strong> <span id="orderDate"></span></p>
                                <p><strong>Status:</strong> <span id="orderStatus"></span></p>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                            <div class="total">
                                <p>Total Amount: ₹<span id="orderAmount"></span></p>
                            </div>
                            <div class="footer">
                                <p>Thank you! Visit Again!</p>
                                <p>Powered by Mirdhuna</p>
                            </div>
                        </body>
                    </html>
                `);

                // Fetch order details and populate the print window
                const orderRef = ref(database, `orders/${orderId}`);
                onValue(orderRef, (snapshot) => {
                    const order = snapshot.val();
                    if (order) {
                        // Get references to elements in the print window
                        const orderDate = printWindow.document.getElementById('orderDate');
                        const orderStatus = printWindow.document.getElementById('orderStatus');
                        const itemsTableBody = printWindow.document.getElementById('itemsTableBody');
                        const orderAmount = printWindow.document.getElementById('orderAmount');

                        // Populate basic order info
                        if (orderDate) orderDate.textContent = new Date(order.timestamp).toLocaleString();
                        if (orderStatus) orderStatus.textContent = order.status || 'Pending';
                        if (orderAmount) orderAmount.textContent = order.amount || '0';

                        // Clear existing items
                        if (itemsTableBody) itemsTableBody.innerHTML = '';

                        // Check if order.items exists and is an object
                        if (order.items && typeof order.items === 'object') {
                            // Iterate over each item in the order
                            Object.values(order.items).forEach(item => {
                                // Calculate line total
                                const lineTotal = (item.price || 0) * (item.quantity || 0);
                                // Create a new table row
                                const row = printWindow.document.createElement('tr');
                                row.innerHTML = `
                                    <td>${item.name || 'Unknown Item'}</td>
                                    <td>${item.quantity || 0}</td>
                                    <td>₹${lineTotal}</td>
                                `;
                                itemsTableBody.appendChild(row);
                            });
                        } else {
                            // Handle case where no items are found
                            const row = printWindow.document.createElement('tr');
                            row.innerHTML = '<td colspan="3">No items found for this order.</td>';
                            itemsTableBody.appendChild(row);
                        }

                        // Trigger the print dialog after a short delay to ensure content is loaded
                        setTimeout(() => {
                            printWindow.print();
                            // Optionally close the print window after printing
                            // printWindow.close();
                        }, 500);

                    } else {
                        printWindow.document.body.innerHTML = '<p>Order not found.</p>';
                    }
                }, { onlyOnce: true });
            };

            window.deleteOrder = function(orderId) {
                console.log(`Delete Order button clicked for ID: ${orderId}`);
                if (confirm('Are you sure you want to delete this order?')) {
                    remove(ref(database, `orders/${orderId}`))
                        .then(() => {
                            alert('Order deleted successfully!');
                            // Reload data
                            if (document.getElementById('orders')?.style.display !== 'none') {
                                loadOrdersData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting order:', error);
                            alert('Error deleting order: ' + error.message);
                        });
                }
            };

            window.deleteSlide = function(slideId) {
                console.log(`Delete Slide button clicked for ID: ${slideId}`);
                if (confirm('Are you sure you want to delete this slide?')) {
                    remove(ref(database, `slides/${slideId}`))
                        .then(() => {
                            alert('Slide deleted successfully!');
                            // Reload data
                            if (document.getElementById('slides')?.style.display !== 'none') {
                                loadSlidesData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting slide:', error);
                            alert('Error deleting slide: ' + error.message);
                        });
                }
            };

            window.deleteMenuItem = function(itemId) {
                console.log(`Delete Menu Item button clicked for ID: ${itemId}`);
                if (confirm('Are you sure you want to delete this menu item?')) {
                    remove(ref(database, `menu/${itemId}`))
                        .then(() => {
                            alert('Menu item deleted successfully!');
                            // Reload data
                            if (document.getElementById('menu')?.style.display !== 'none') {
                                loadMenuData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting menu item:', error);
                            alert('Error deleting menu item: ' + error.message);
                        });
                }
            };

            // Initial load of dashboard data
            console.log("Initial dashboard data load triggered.");
            loadDashboardData();

        }); // End of DOMContentLoaded
        console.log("Script module loaded. Waiting for DOMContentLoaded...");
    </script>
    // Preview image as admin types/pastes URL
const slideImageUrlInput = document.getElementById('slideImageUrl');
const slidePreview = document.getElementById('slidePreview');
slideImageUrlInput.addEventListener('input', () => {
  const url = slideImageUrlInput.value.trim();
  slidePreview.innerHTML = url ? `<img src="${url}" style="max-width:200px;max-height:120px;" onerror="this.style.display='none'">` : "";
});

const uploadSlideBtn = document.getElementById('uploadSlideBtn');
uploadSlideBtn.addEventListener('click', async function(event) {
  event.preventDefault();
  const imageUrl = slideImageUrlInput.value.trim();
  if (!imageUrl || !/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg)$/i.test(imageUrl)) {
    alert('Please enter a valid image URL (must be a direct .jpg, .png, .gif, .webp, .svg).');
    return;
  }
  // Save URL as you already do...
  const newSlideRef = firebase.database().ref('slides').push();
  await newSlideRef.set({
    url: imageUrl,
    timestamp: new Date().toISOString()
  });
  slideImageUrlInput.value = '';
  slidePreview.innerHTML = '';
  alert('Slide added successfully!');
  loadSlidesData();
});
</body>
    </html>
