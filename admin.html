<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar: #1e293b;
            --header: #ffffff;
            --card: #ffffff;
            --text: #333333;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f1f5f9;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--sidebar);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            color: #cbd5e1;
            text-decoration: none;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid var(--success);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #d1146a;
        }

        /* Content Area */
        .content {
            padding: 30px;
        }

        .card {
            background: var(--card);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--dark);
        }

        .card-body {
            padding: 20px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-print {
            background: var(--info);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .stat-icon.orders {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .stat-icon.revenue {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .stat-icon.views {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
        }

        .stat-icon.users {
            background: rgba(72, 149, 239, 0.1);
            color: var(--info);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #64748b;
            margin: 0;
        }

        /* Login Form */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark);
        }

        .error-message {
            color: var(--danger);
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        /* Blur effect for content when not logged in */
        .blur-content {
            filter: blur(10px);
            pointer-events: none;
        }

        /* Upload Previews */
        .upload-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            display: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar-menu a span {
                display: none;
            }
            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }
            .main-content {
                margin-left: 0;
            }
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>Admin Login</h2>
            <div class="error-message" id="errorMessage">Invalid password. Please try again.</div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
            </div>
            <button class="btn btn-submit" id="loginBtn">Login</button>
        </div>
    </div>

    <!-- Main Content (Blurred initially) -->
    <div class="container blur-content" id="mainContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Admin Panel</h3>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="#" class="active" data-target="dashboard"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a></li>
                    <li><a href="#" data-target="orders"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                    <li><a href="#" data-target="users"><i class="fas fa-users"></i> <span>User Login History</span></a></li>
                    <li><a href="#" data-target="slides"><i class="fas fa-images"></i> <span>Slide Management</span></a></li>
                    <li><a href="#" data-target="menu"><i class="fas fa-utensils"></i> <span>Menu Management</span></a></li>
                    <li><a href="#" data-target="analytics"><i class="fas fa-chart-bar"></i> <span>Analytics</span></a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Admin Dashboard</h1>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Content Sections -->
            <div class="content">
                <!-- Dashboard -->
                <div class="section active" id="dashboard">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon orders">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalOrders">0</h3>
                                <p>Total Orders</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon revenue">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalRevenue">₹0</h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon views">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayViews">0</h3>
                                <p>Today's Views</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Users</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Recent Orders</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Time</th>
                                            <th>Items</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersTable">
                                        <!-- Recent orders will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="section" id="orders" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Order History</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Time</th>
                                            <th>Items</th>
                                            <th>No. of Items</th>
                                            <th>Amount</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTable">
                                        <!-- Orders will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Login History -->
                <div class="section" id="users" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>User Login History</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Login Time</th>
                                            <th>IP Address</th>
                                            <th>Device</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userLoginTable">
                                        <!-- User login history will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide Management -->
                <div class="section" id="slides" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Slide Management</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="slideImage">Upload Slide Image</label>
                                <input type="file" id="slideImage" class="form-control" accept="image/*">
                                <img id="slidePreview" class="upload-preview" alt="Slide Preview">
                            </div>
                            <button class="btn btn-submit" id="uploadSlideBtn">
                                <i class="fas fa-upload"></i> Upload Slide
                            </button>

                            <div class="table-container" style="margin-top: 30px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Slide</th>
                                            <th>Upload Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="slidesTable">
                                        <!-- Slides will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Management -->
                <div class="section" id="menu" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Menu Management</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="itemName">Item Name</label>
                                <input type="text" id="itemName" class="form-control" placeholder="Enter item name">
                            </div>
                            <div class="form-group">
                                <label for="itemPrice">Price</label>
                                <input type="number" id="itemPrice" class="form-control" placeholder="Enter price">
                            </div>
                            <div class="form-group">
                                <label for="itemImage">Item Image</label>
                                <input type="file" id="itemImage" class="form-control" accept="image/*">
                                <img id="itemPreview" class="upload-preview" alt="Item Preview">
                            </div>
                            <button class="btn btn-submit" id="addItemBtn">
                                <i class="fas fa-plus"></i> Add Item
                            </button>

                            <div class="table-container" style="margin-top: 30px;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="menuTable">
                                        <!-- Menu items will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="section" id="analytics" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Analytics</h2>
                        </div>
                        <div class="card-body">
                            <div class="stats-container">
                                <div class="stat-card">
                                    <div class="stat-icon views">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3 id="todayViewsAnalytics">0</h3>
                                        <p>Today's Views</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon views">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3 id="totalViewsAnalytics">0</h3>
                                        <p>Total Views</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h2>View Statistics</h2>
                                </div>
                                <div class="card-body">
                                    <p>Note: Chart implementation requires additional libraries like Chart.js. This section shows data structure.</p>
                                    <div id="analyticsDataDisplay">
                                        <!-- Data will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        // Import Firebase Storage
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCiG3Tal0dCpBAV1SLS2Rbs6GYOA4zomQE",
            authDomain: "mirdhuna-4f652.firebaseapp.com",
            databaseURL: "https://mirdhuna-4f652-default-rtdb.firebaseio.com",
            projectId: "mirdhuna-4f652",
            storageBucket: "mirdhuna-4f652.firebasestorage.app",
            messagingSenderId: "184403369330",
            appId: "1:184403369330:web:859bcf3162bc2d2ed7d1eb",
            measurementId: "G-ZFWSGKE744"
        };

        // Initialize Firebase
        console.log("Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        // Initialize Firebase Storage
        const storage = getStorage(app);
        console.log("Firebase initialized.");

        // --- DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM fully loaded and parsed.");

            // Authentication Elements
            const correctPassword = "Sanu.0000";
            const loginContainer = document.getElementById('loginContainer');
            const mainContainer = document.getElementById('mainContainer');
            const adminPassword = document.getElementById('adminPassword');
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            const logoutBtn = document.getElementById('logoutBtn');

            // Check if already logged in
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                console.log("User already logged in.");
                loginContainer.style.display = 'none';
                mainContainer.classList.remove('blur-content');
            }

            loginBtn.addEventListener('click', function() {
                console.log("Login button clicked.");
                if (adminPassword.value === correctPassword) {
                    console.log("Password correct.");
                    loginContainer.style.display = 'none';
                    mainContainer.classList.remove('blur-content');
                    localStorage.setItem('adminLoggedIn', 'true');
                } else {
                    console.log("Password incorrect.");
                    errorMessage.style.display = 'block';
                }
            });

            logoutBtn.addEventListener('click', function() {
                console.log("Logout button clicked.");
                localStorage.removeItem('adminLoggedIn');
                location.reload();
            });

            // Navigation
            const navLinks = document.querySelectorAll('.sidebar-menu a');
            const sections = document.querySelectorAll('.section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log(`Navigation link clicked: ${this.getAttribute('data-target')}`);

                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.style.display = 'none');

                    // Add active class to clicked link
                    this.classList.add('active');

                    // Show corresponding section
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).style.display = 'block';

                    // Load data for the section
                    loadDataForSection(target);
                });
            });

            // Add preview functionality for images
            document.getElementById('slideImage').addEventListener('change', function(event) {
                console.log("Slide image file selected.");
                const file = event.target.files[0];
                const preview = document.getElementById('slidePreview');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            document.getElementById('itemImage').addEventListener('change', function(event) {
                console.log("Menu item image file selected.");
                const file = event.target.files[0];
                const preview = document.getElementById('itemPreview');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            // --- Firebase Interaction Functions ---

            // Load data for each section
            function loadDataForSection(section) {
                console.log(`Loading data for section: ${section}`);
                switch(section) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'orders':
                        loadOrdersData();
                        break;
                    case 'users':
                        loadUserLoginData();
                        break;
                    case 'slides':
                        loadSlidesData();
                        break;
                    case 'menu':
                        loadMenuData();
                        break;
                    case 'analytics':
                        loadAnalyticsData();
                        break;
                }
            }

            // Dashboard Data
            function loadDashboardData() {
                console.log("Loading Dashboard data...");
                // Load total orders
                const ordersRef = ref(database, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const orders = snapshot.val();
                    if (orders) {
                        const orderCount = Object.keys(orders).length;
                        document.getElementById('totalOrders').textContent = orderCount;

                        // Calculate total revenue
                        let totalRevenue = 0;
                        Object.values(orders).forEach(order => {
                            totalRevenue += order.amount || 0;
                        });
                        document.getElementById('totalRevenue').textContent = `₹${totalRevenue}`;

                        // Populate recent orders
                        const recentOrdersTable = document.getElementById('recentOrdersTable');
                        recentOrdersTable.innerHTML = '';

                        // Get last 5 orders
                        const orderEntries = Object.entries(orders);
                        const recentOrders = orderEntries.slice(-5);

                        recentOrders.forEach(([id, order]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${id}</td>
                                <td>${new Date(order.timestamp).toLocaleString()}</td>
                                <td>${order.items ? Object.keys(order.items).length : 0} items</td>
                                <td>₹${order.amount || 0}</td>
                                <td><span class="status ${order.status || 'pending'}">${order.status || 'Pending'}</span></td>
                            `;
                            recentOrdersTable.appendChild(row);
                        });
                    } else {
                         document.getElementById('totalOrders').textContent = '0';
                         document.getElementById('totalRevenue').textContent = '₹0';
                         document.getElementById('recentOrdersTable').innerHTML = '<tr><td colspan="5">No orders found</td></tr>';
                    }
                });

                // Load today's views
                const analyticsRef = ref(database, 'analytics');
                onValue(analyticsRef, (snapshot) => {
                    const analyticsData = snapshot.val();
                    const today = new Date().toISOString().split('T')[0];
                    let todayViews = 0;

                    if (analyticsData && analyticsData.pageViews && analyticsData.pageViews[today] !== undefined) {
                        todayViews = analyticsData.pageViews[today];
                    }
                    document.getElementById('todayViews').textContent = todayViews;
                });

                // Load total users
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const users = snapshot.val();
                    if (users) {
                        const userCount = Object.keys(users).length;
                        document.getElementById('totalUsers').textContent = userCount;
                    } else {
                        document.getElementById('totalUsers').textContent = '0';
                    }
                });
            }

            // Orders Data
            function loadOrdersData() {
                console.log("Loading Orders data...");
                const ordersRef = ref(database, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const orders = snapshot.val();
                    const ordersTable = document.getElementById('ordersTable');
                    ordersTable.innerHTML = '';

                    if (orders) {
                        Object.entries(orders).forEach(([id, order]) => {
                            const row = document.createElement('tr');
                            const itemsCount = order.items ? Object.keys(order.items).length : 0;
                            let itemsList = '';
                            if (order.items) {
                                itemsList = Object.values(order.items).map(item => item.name).join(', ');
                            }

                            row.innerHTML = `
                                <td>${id}</td>
                                <td>${new Date(order.timestamp).toLocaleString()}</td>
                                <td>${itemsList}</td>
                                <td>${itemsCount}</td>
                                <td>₹${order.amount || 0}</td>
                                <td>${order.location || 'N/A'}</td>
                                <td>
                                    <select class="status-select" data-order-id="${id}">
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-print" onclick="printOrder('${id}')">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteOrder('${id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            ordersTable.appendChild(row);
                        });

                        // Add event listeners for status changes
                        document.querySelectorAll('.status-select').forEach(select => {
                            select.addEventListener('change', function() {
                                const orderId = this.getAttribute('data-order-id');
                                const newStatus = this.value;
                                console.log(`Updating order ${orderId} status to ${newStatus}`);
                                update(ref(database, `orders/${orderId}`), {
                                    status: newStatus
                                });
                            });
                        });
                    } else {
                        ordersTable.innerHTML = '<tr><td colspan="8">No orders found</td></tr>';
                    }
                });
            }

            // User Login Data
            function loadUserLoginData() {
                console.log("Loading User Login data...");
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const users = snapshot.val();
                    const userLoginTable = document.getElementById('userLoginTable');
                    userLoginTable.innerHTML = '';

                    if (users) {
                        Object.entries(users).forEach(([userId, userData]) => {
                            if (userData.loginHistory) {
                                Object.values(userData.loginHistory).forEach(login => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${userId}</td>
                                        <td>${new Date(login.timestamp).toLocaleString()}</td>
                                        <td>${login.ip || 'N/A'}</td>
                                        <td>${login.device || 'N/A'}</td>
                                    `;
                                    userLoginTable.appendChild(row);
                                });
                            }
                        });
                         if (userLoginTable.innerHTML === '') {
                             userLoginTable.innerHTML = '<tr><td colspan="4">No user login history found</td></tr>';
                         }
                    } else {
                        userLoginTable.innerHTML = '<tr><td colspan="4">No users found</td></tr>';
                    }
                });
            }

            // Slides Data (Fixed Image Upload)
            function loadSlidesData() {
                console.log("Loading Slides data...");
                const slidesRef = ref(database, 'slides');
                onValue(slidesRef, (snapshot) => {
                    const slides = snapshot.val();
                    const slidesTable = document.getElementById('slidesTable');
                    slidesTable.innerHTML = '';

                    if (slides) {
                        Object.entries(slides).forEach(([id, slide]) => {
                            const row = document.createElement('tr');
                            // Use the stored URL from Storage
                            row.innerHTML = `
                                <td><img src="${slide.url}" alt="Slide" style="width: 100px; height: 60px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/100x60?text=Image+Not+Found';"></td>
                                <td>${new Date(slide.timestamp).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-delete" onclick="deleteSlide('${id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            `;
                            slidesTable.appendChild(row);
                        });
                    } else {
                         slidesTable.innerHTML = '<tr><td colspan="3">No slides found</td></tr>';
                    }
                });

                // --- Upload slide to Firebase Storage ---
                // Ensure the button exists before adding the listener
                const uploadSlideBtn = document.getElementById('uploadSlideBtn');
                if (uploadSlideBtn) {
                    uploadSlideBtn.addEventListener('click', async function() {
                        console.log("Upload Slide button clicked.");
                        const fileInput = document.getElementById('slideImage');
                        const file = fileInput.files[0];

                        if (!file) {
                            alert('Please select an image file.');
                            return;
                        }

                        try {
                            // Create a reference to the file location in Storage
                            const fileName = `${Date.now()}_${file.name}`;
                            const storageReference = storageRef(storage, `slides/${fileName}`);
                            console.log(`Preparing to upload slide: ${fileName}`);

                            // Upload the file
                            const snapshot = await uploadBytes(storageReference, file);
                            console.log('Slide uploaded to Storage:', snapshot);

                            // Get the public download URL
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            console.log('Slide File available at:', downloadURL);

                            // Save the URL and metadata to the Realtime Database
                            const newSlideRef = push(ref(database, 'slides'));
                            await set(newSlideRef, {
                                url: downloadURL, // Store the permanent URL
                                name: file.name,
                                timestamp: new Date().toISOString()
                            });
                            console.log('Slide data saved to Realtime Database.');

                            // Reset form
                            fileInput.value = '';
                            document.getElementById('slidePreview').style.display = 'none';
                            alert('Slide uploaded successfully!');
                            // Reload data to show new slide
                            loadSlidesData();

                        } catch (error) {
                            console.error('Error uploading slide:', error);
                            alert('Error uploading slide: ' + error.message);
                        }
                    });
                } else {
                    console.error("Upload Slide button not found in DOM.");
                }
            }

            // Menu Data (Fixed Image Upload)
            function loadMenuData() {
                console.log("Loading Menu data...");
                const menuRef = ref(database, 'menu');
                onValue(menuRef, (snapshot) => {
                    const menu = snapshot.val();
                    const menuTable = document.getElementById('menuTable');
                    menuTable.innerHTML = '';

                    if (menu) {
                        Object.entries(menu).forEach(([id, item]) => {
                            const row = document.createElement('tr');
                            // Use the stored URL from Storage
                            row.innerHTML = `
                                <td><img src="${item.image || 'https://via.placeholder.com/60?text=No+Image'}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=Image+Not+Found';"></td>
                                <td>${item.name}</td>
                                <td>₹${item.price}</td>
                                <td>
                                    <button class="btn btn-edit" onclick="editMenuItem('${id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteMenuItem('${id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            `;
                            menuTable.appendChild(row);
                        });
                    } else {
                        menuTable.innerHTML = '<tr><td colspan="4">No menu items found</td></tr>';
                    }
                });

                // --- Add menu item with image upload to Firebase Storage ---
                // Ensure the button exists before adding the listener
                const addItemBtn = document.getElementById('addItemBtn');
                if (addItemBtn) {
                    addItemBtn.addEventListener('click', async function() {
                        console.log("Add Item button clicked.");
                        const name = document.getElementById('itemName').value.trim();
                        const price = document.getElementById('itemPrice').value.trim();
                        const fileInput = document.getElementById('itemImage');
                        const file = fileInput.files[0];

                        if (!name || !price) {
                            alert('Please enter item name and price.');
                            return;
                        }

                        let imageUrl = ''; // Initialize image URL

                        if (file) {
                            try {
                                // Create a reference to the file location in Storage
                                const fileName = `${Date.now()}_${file.name}`;
                                const storageReference = storageRef(storage, `menu_items/${fileName}`);
                                console.log(`Preparing to upload menu item image: ${fileName}`);

                                // Upload the file
                                const snapshot = await uploadBytes(storageReference, file);
                                console.log('Menu item image uploaded to Storage:', snapshot);

                                // Get the public download URL
                                imageUrl = await getDownloadURL(snapshot.ref);
                                console.log('Menu item File available at:', imageUrl);

                            } catch (error) {
                                console.error('Error uploading menu item image:', error);
                                alert('Error uploading image: ' + error.message);
                                return; // Stop if image upload fails
                            }
                        } else {
                             console.log("No image file selected for menu item.");
                        }

                        try {
                            // Save the item data (including the image URL) to the Realtime Database
                            const newItemRef = push(ref(database, 'menu'));
                            await set(newItemRef, {
                                name: name,
                                price: parseFloat(price),
                                image: imageUrl, // Store the permanent URL (can be empty string if no file)
                                timestamp: new Date().toISOString()
                            });
                            console.log('Menu item data saved to Realtime Database.');

                            // Reset form
                            document.getElementById('itemName').value = '';
                            document.getElementById('itemPrice').value = '';
                            fileInput.value = '';
                            document.getElementById('itemPreview').style.display = 'none';
                            alert('Menu item added successfully!');
                            // Reload data to show new item
                            loadMenuData();

                        } catch (error) {
                            console.error('Error adding menu item:', error);
                            alert('Error adding menu item: ' + error.message);
                        }
                    });
                } else {
                     console.error("Add Item button not found in DOM.");
                }
            }

            // Analytics Data (Fixed Reading Logic)
            function loadAnalyticsData() {
                console.log("Loading Analytics data...");
                const analyticsRef = ref(database, 'analytics');
                onValue(analyticsRef, (snapshot) => {
                    // Get the raw data object
                    const analyticsData = snapshot.val();

                    // Get references to the HTML elements to update
                    const todayViewsElement = document.getElementById('todayViewsAnalytics');
                    const totalViewsElement = document.getElementById('totalViewsAnalytics');
                    const dataDisplayElement = document.getElementById('analyticsDataDisplay'); // For detailed view

                    // Get today's date string (YYYY-MM-DD)
                    const today = new Date().toISOString().split('T')[0];

                    // Check if data exists
                    if (analyticsData) {
                        // Try to get today's views, default to 0 if not found
                        const todayViews = (analyticsData.pageViews && analyticsData.pageViews[today]) ? analyticsData.pageViews[today] : 0;

                        // Try to get total views, default to 0 if not found
                        const totalViews = analyticsData.totalViews || 0;

                        // Update the HTML elements
                        todayViewsElement.textContent = todayViews;
                        totalViewsElement.textContent = totalViews;

                        // Display detailed data structure for debugging/viewing
                        if (analyticsData.pageViews) {
                            let pageViewsHtml = '<h3>Page Views by Date:</h3><ul>';
                            for (const [date, count] of Object.entries(analyticsData.pageViews)) {
                                pageViewsHtml += `<li>${date}: ${count} views</li>`;
                            }
                            pageViewsHtml += '</ul>';
                            dataDisplayElement.innerHTML = pageViewsHtml;
                        } else {
                            dataDisplayElement.innerHTML = '<p>No page view data available yet.</p>';
                        }

                    } else {
                        // Handle case where 'analytics' node doesn't exist at all
                        console.log("Analytics data not found in database.");
                        todayViewsElement.textContent = '0';
                        totalViewsElement.textContent = '0';
                        dataDisplayElement.innerHTML = '<p>No analytics data found. Ensure your main website is sending analytics data.</p>';
                    }
                });
            }

            // --- Global functions for buttons ---
            window.printOrder = function(orderId) {
                console.log(`Print Order button clicked for ID: ${orderId}`);
                // Create a printable version of the order
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Order #${orderId}</title>
                            <style>
                                body { font-family: Arial, sans-serif; }
                                .header { text-align: center; margin-bottom: 20px; }
                                .order-details { margin-bottom: 20px; }
                                table { width: 100%; border-collapse: collapse; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>Restaurant Order</h1>
                                <p>Order ID: ${orderId}</p>
                            </div>
                            <div class="order-details" id="orderDetails">
                                <!-- Order details will be populated here -->
                            </div>
                        </body>
                    </html>
                `);

                // Fetch order details and populate the print window
                const orderRef = ref(database, `orders/${orderId}`);
                onValue(orderRef, (snapshot) => {
                    const order = snapshot.val();
                    if (order) {
                        const orderDetails = printWindow.document.getElementById('orderDetails');
                        let itemsHtml = '';
                        if (order.items) {
                            itemsHtml = `
                                <h2>Items</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.values(order.items || {}).map(item => `
                                            <tr>
                                                <td>${item.name}</td>
                                                <td>${item.quantity}</td>
                                                <td>₹${item.price * item.quantity}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        } else {
                            itemsHtml = '<p>No items found for this order.</p>';
                        }

                        orderDetails.innerHTML = `
                            <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> ₹${order.amount}</p>
                            <p><strong>Status:</strong> ${order.status || 'Pending'}</p>
                            ${itemsHtml}
                        `;
                        printWindow.print();
                    } else {
                        printWindow.document.body.innerHTML = '<p>Order not found.</p>';
                    }
                }, { onlyOnce: true });
            };

            window.deleteOrder = function(orderId) {
                console.log(`Delete Order button clicked for ID: ${orderId}`);
                if (confirm('Are you sure you want to delete this order?')) {
                    remove(ref(database, `orders/${orderId}`))
                        .then(() => {
                            alert('Order deleted successfully!');
                            // Reload data
                            if (document.getElementById('orders').style.display !== 'none') {
                                loadOrdersData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting order:', error);
                            alert('Error deleting order: ' + error.message);
                        });
                }
            };

            window.deleteSlide = function(slideId) {
                console.log(`Delete Slide button clicked for ID: ${slideId}`);
                if (confirm('Are you sure you want to delete this slide?')) {
                    remove(ref(database, `slides/${slideId}`))
                        .then(() => {
                            alert('Slide deleted successfully!');
                            // Reload data
                            if (document.getElementById('slides').style.display !== 'none') {
                                loadSlidesData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting slide:', error);
                            alert('Error deleting slide: ' + error.message);
                        });
                }
            };

            window.deleteMenuItem = function(itemId) {
                console.log(`Delete Menu Item button clicked for ID: ${itemId}`);
                if (confirm('Are you sure you want to delete this menu item?')) {
                    remove(ref(database, `menu/${itemId}`))
                        .then(() => {
                            alert('Menu item deleted successfully!');
                            // Reload data
                            if (document.getElementById('menu').style.display !== 'none') {
                                loadMenuData();
                            }
                        })
                        .catch((error) => {
                            console.error('Error deleting menu item:', error);
                            alert('Error deleting menu item: ' + error.message);
                        });
                }
            };

            window.editMenuItem = function(itemId) {
                console.log(`Edit Menu Item button clicked for ID: ${itemId}`);
                // In a real implementation, you would show a modal with the item details
                alert('Edit functionality would be implemented here. Item ID: ' + itemId);
            };

            // Initial load of dashboard data
            console.log("Initial dashboard data load triggered.");
            loadDashboardData();

        }); // End of DOMContentLoaded
    </script>
</body>
</html>
