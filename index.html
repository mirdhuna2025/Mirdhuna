<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIRDHUNA - Order Online</title>
    <!-- ... other meta and style tags ... -->

    <!-- Firebase SDK (v12, module form) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import { getDatabase, ref, push, set, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCiG3Tal0dCpBAV1SLS2Rbs6GYOA4zomQE",
        authDomain: "mirdhuna-4f652.firebaseapp.com",
        databaseURL: "https://mirdhuna-4f652-default-rtdb.firebaseio.com",
        projectId: "mirdhuna-4f652",
        storageBucket: "mirdhuna-4f652.appspot.com",
        messagingSenderId: "184403369330",
        appId: "1:184403369330:web:859bcf3162bc2d2ed7d1eb",
        measurementId: "G-ZFWSGKE744"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Make Firebase available globally for inline scripts
      window.myFirebase = { db, ref, push, set, query, orderByChild, equalTo, get };
    </script>
</head>
<body>
    <!-- ... your existing HTML UI code ... -->

    <script type="module">
      // Assume: currentUser, userLocation, cart, total, userLoggedIn are defined elsewhere in your UI code

      // Save order to Firebase
      async function saveOrderToFirebase(mobile, location, items, total) {
        const order = {
          mobile,
          location,
          items,
          total,
          status: "Pending",
          timestamp: new Date().toISOString()
        };
        const { db, ref, push, set } = window.myFirebase;
        const ordersRef = ref(db, "orders");
        const newOrderRef = push(ordersRef);
        await set(newOrderRef, order);
        return newOrderRef.key;
      }

      // Load user order history from Firebase
      async function loadUserOrderHistory(mobile) {
        const { db, ref, query, orderByChild, equalTo, get } = window.myFirebase;
        const ordersRef = ref(db, "orders");
        // Query for orders where mobile == user's mobile
        const q = query(ordersRef, orderByChild("mobile"), equalTo(mobile));
        const snapshot = await get(q);
        let userOrders = [];
        if (snapshot.exists()) {
          snapshot.forEach(childSnap => {
            const o = childSnap.val();
            o.id = childSnap.key;
            userOrders.push(o);
          });
        }
        // Sort by timestamp descending
        userOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        // Render order history (replace with your UI logic)
        const orderHistoryList = document.getElementById('orderHistoryList');
        orderHistoryList.innerHTML = '';
        if (userOrders.length === 0) {
          orderHistoryList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No order history found</p>';
        } else {
          userOrders.forEach(order => {
            const orderDate = new Date(order.timestamp).toLocaleDateString();
            const orderTime = new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const orderElement = document.createElement('div');
            orderElement.className = 'order-item';
            orderElement.innerHTML = `
              <div class="order-header">
                  <span>Order ID: ${order.id}</span>
                  <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
              </div>
              <div>Date: ${orderDate} at ${orderTime}</div>
              <div class="order-items">
                  Items: ${order.items.map(item => item.name).join(', ')}
              </div>
              <div class="order-total">Total: ₹${order.total}</div>
            `;
            orderHistoryList.appendChild(orderElement);
          });
        }
      }

      // Place order button logic (replace your old handler)
      placeOrderBtn.addEventListener('click', async function() {
        if (!userLoggedIn) {
          alert('Please login first to place an order.');
          hideModal(checkoutModal);
          showModal(loginModal);
          return;
        }
        if (cart.length === 0) {
          alert('Your cart is empty! Please add items before checkout.');
          return;
        }
        const orderId = await saveOrderToFirebase(currentUser.mobile, userLocation, cart, total);
        alert(`Order placed successfully!\nOrder ID: ${orderId}\nTotal: ₹${total}\nThank you for ordering with MIRDHUNA!`);
        cart = [];
        updateCart();
        hideModal(checkoutModal);
        loadUserOrderHistory(currentUser.mobile);
      });

      // On login or page load, call:
      // loadUserOrderHistory(currentUser.mobile);

    </script>
    <!-- ... rest of your HTML ... -->
</body>
</html>
