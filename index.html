<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIRDHUNA | Premium Food Experience</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage (for potential future image uploads if needed by admin) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
      authDomain: "mirdhuna-25542.firebaseapp.com",
      databaseURL: "https://mirdhuna-25542-default-rtdb.firebaseio.com",
      projectId: "mirdhuna-25542",
      storageBucket: "mirdhuna-25542.firebasestorage.app",
      messagingSenderId: "575924409876",
      appId: "1:575924409876:web:6ba1ed88ce941d9c83b901",
      measurementId: "G-YB7LDKHBPV"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
            heading: ['Playfair Display', 'serif']
          },
          colors: {
            primary: '#e11d48',
            secondary: '#f43f5e',
            accent: '#f97316',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 3s infinite'
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fff9f0 0%, #fff1f2 100%);
      overflow-x: hidden;
    }

    .hero-gradient {
      background: linear-gradient(135deg, rgba(225, 29, 72, 0.9) 0%, rgba(249, 115, 22, 0.85) 100%);
    }

    .menu-card {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .menu-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .btn-primary {
      background: linear-gradient(135deg, #e11d48 0%, #f97316 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(225, 29, 72, 0.4);
    }

    .history-item {
      border-left: 4px solid #e11d48;
      transition: all 0.3s ease;
    }

    .history-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-50px);
      transition: all 0.4s;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      font-weight: bold;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
    }

    .nav-item.active {
      color: #e11d48;
      font-weight: 600;
      position: relative;
    }

    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: #e11d48;
      border-radius: 3px;
    }

    .floating-element {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .two-col-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .two-col-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
        animation: modalopen 0.4s;
    }

    @keyframes modalopen {
        from {opacity: 0; transform: translateY(-60px);}
        to {opacity: 1; transform: translateY(0);}
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }

    /* Loading Spinner */
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #e11d48;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

  </style>
</head>
<body class="min-h-screen">

  <!-- Toast Notification -->
  <div id="toast" class="toast">Item added to cart!</div>

  <!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content glass-card">
    <span class="close" onclick="closeLoginModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <input type="text" id="userMobile" placeholder="Enter your mobile number (e.g., 9835124772)" class="w-full p-2 mb-4 border rounded">
    <button onclick="performLogin()" class="btn-primary w-full px-4 py-2 rounded font-bold">Login</button>
    <div id="loginSpinner" class="spinner"></div>
    <p id="loginMessage" class="text-red-500 text-center mt-2"></p>
  </div>
</div>

 <!-- Order Confirmation Modal -->
<div id="orderModal" class="modal">
  <div class="modal-content glass-card">
    <span class="close" onclick="closeOrderModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-4 text-center">Confirm Order</h2>
    <div id="orderDetails"></div>
    <p class="mt-4 text-sm text-gray-600"><i class="fas fa-info-circle mr-2"></i> Your location will be detected.</p>
    <button onclick="placeOrder()" class="btn-primary w-full mt-4 px-4 py-2 rounded font-bold">Place Order</button>
    <div id="orderSpinner" class="spinner"></div>
    <p id="orderMessage" class="text-red-500 text-center mt-2"></p>
  </div>
</div>

  <!-- Header -->
  <header class="hero-gradient text-white py-16 px-4 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10">
      <div class="absolute top-10 left-10 w-64 h-64 bg-white rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob"></div>
      <div class="absolute top-10 right-10 w-64 h-64 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-2000"></div>
      <div class="absolute bottom-10 left-1/2 w-64 h-64 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Floating food elements -->
    <div class="absolute bottom-20 left-10 floating-element">
      <div class="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-pizza-slice text-white text-2xl"></i>
      </div>
    </div>
    <div class="absolute top-24 right-20 floating-element animation-delay-1000">
      <div class="w-12 h-12 bg-red-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-hamburger text-white text-xl"></i>
      </div>
    </div>
    <div class="absolute top-1/3 left-1/4 floating-element animation-delay-2000">
      <div class="w-10 h-10 bg-green-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-martini-glass text-white"></i>
      </div>
    </div>

    <div class="container mx-auto relative z-10 text-center">
      <h1 class="text-5xl md:text-7xl font-heading font-bold mb-4 tracking-tight">MIRDHUNA</h1>
      <p class="text-xl md:text-2xl mb-8 max-w-2xl mx-auto">Experience Culinary Excellence with Every Bite</p>
      <div class="flex justify-center gap-4">
        <button onclick="showSection('menu')" class="btn-primary px-8 py-3 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all">
          <i class="fas fa-utensils mr-2"></i> Order Now
        </button>
        <button onclick="openLoginModal()" id="loginButton" class="bg-white bg-opacity-20 backdrop-blur-sm px-8 py-3 rounded-full font-bold text-lg hover:bg-opacity-30 transition-all">
          <i class="fas fa-user mr-2"></i> Login
        </button>
         <!-- Cart Icon with Badge -->
        <div class="relative">
            <button onclick="openOrderModal()" class="bg-white bg-opacity-20 backdrop-blur-sm p-3 rounded-full hover:bg-opacity-30 transition-all">
                <i class="fas fa-shopping-cart text-xl"></i>
                 <span id="cartBadge" class="cart-badge">0</span>
            </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Menu Section -->
  <section id="menu" class="py-16 px-4">
    <div class="container mx-auto">
      <h2 class="text-4xl font-heading font-bold text-center mb-12 text-dark">Our Delicious Menu</h2>

      <!-- Menu Categories -->
      <div class="mb-12">
        <div class="flex flex-wrap justify-center gap-4 mb-8">
          <button onclick="filterMenu('all')" class="px-6 py-2 rounded-full bg-primary text-white font-medium hover:bg-secondary transition-colors active-category">All Items</button>
          <button onclick="filterMenu('Pizza')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Pizza</button>
          <button onclick="filterMenu('Burger')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Burger</button>
          <button onclick="filterMenu('Sandwich')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Sandwich</button>
          <button onclick="filterMenu('Shakes')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Shakes</button>
        </div>

        <!-- Menu Items Grid -->
        <div id="menuGrid" class="two-col-grid">
          <!-- Menu items will be dynamically inserted here -->
        </div>
         <div id="menuSpinner" class="spinner"></div>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
<section id="contact" class="py-16 px-4 bg-light">
  <div class="container mx-auto">
    <h2 class="text-4xl font-heading font-bold text-center mb-12 text-dark">Visit Us</h2>
    <div class="flex flex-col md:flex-row items-center justify-center gap-12">
      <div class="text-center md:text-left">
        <h3 class="text-2xl font-bold mb-4 text-dark">MIRDHUNA Cafe</h3>
        <p class="mb-2 flex items-center justify-center md:justify-start">
          <i class="fas fa-map-marker-alt mr-3 text-primary"></i>
          <a href="https://maps.app.goo.gl/kotovw4g7chuqy5J8" target="_blank" class="hover:text-primary transition-colors">
              Find us on Google Maps
          </a>
        </p>
        <p class="mb-2 flex items-center justify-center md:justify-start">
          <i class="fas fa-phone mr-3 text-primary"></i>
          <a href="tel:9835124772" class="hover:text-primary transition-colors">9835124772</a>
        </p>
        <p class="flex items-center justify-center md:justify-start">
          <i class="fab fa-whatsapp mr-3 text-primary"></i>
          <a href="https://wa.me/9835124772" target="_blank" class="hover:text-primary transition-colors">WhatsApp Us</a>
        </p>
      </div>
       <div class="w-full md:w-1/2 h-64 md:h-80 rounded-xl overflow-hidden shadow-lg">
        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3001156.428106995!2d74.24191583056642!3d19.997458000000003!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bddeb44b491e88f%3A0x6c747e368e1b758b!2sMirdhuna%20Cafe!5e0!3m2!1sen!2sin!5m2!1sen!2sin" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>
</section>

  <!-- Footer -->
  <footer class="bg-dark text-white py-8 px-4">
    <div class="container mx-auto text-center">
      <p>&copy; 2024 MIRDHUNA Cafe. All rights reserved.</p>
      <div class="mt-4 flex justify-center space-x-6">
        <a href="#" class="text-gray-400 hover:text-white transition-colors">
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="#" class="text-gray-400 hover:text-white transition-colors">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://wa.me/9835124772" target="_blank" class="text-gray-400 hover:text-white transition-colors">
          <i class="fab fa-whatsapp"></i>
        </a>
      </div>
    </div>
  </footer>

  <script>
    // --- State Management ---
    let cart = JSON.parse(localStorage.getItem('mirdhunaCart')) || [];
    let currentUser = JSON.parse(localStorage.getItem('mirdhunaUser')) || null; // { mobile: '...', location: { lat, lng } }

    // --- Firebase Firestore Menu Listener ---
    function loadMenu() {
        const spinner = document.getElementById('menuSpinner');
        spinner.style.display = 'block';
        const menuGrid = document.getElementById('menuGrid');
        menuGrid.innerHTML = '';

        db.collection('menuItems')
            .orderBy('category')
            .onSnapshot(snapshot => {
                spinner.style.display = 'none';
                menuGrid.innerHTML = '';
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" || change.type === "modified") {
                        const item = { id: change.doc.id, ...change.doc.data() };
                        renderMenuItem(item);
                    }
                    if (change.type === "removed") {
                        const itemElement = document.getElementById(`item-${change.doc.id}`);
                        if(itemElement) itemElement.remove();
                    }
                });
                filterMenu('all'); // Initially show all items
            }, error => {
                spinner.style.display = 'none';
                console.error("Error loading menu:", error);
                showToast("Failed to load menu.");
            });
    }

    function renderMenuItem(item) {
        const menuGrid = document.getElementById('menuGrid');
        const menuItemHTML = `
            <div id="item-${item.id}" class="menu-card bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl">
                <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${item.name}" class="w-full h-48 object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Error';">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-dark">${item.name}</h3>
                        <span class="text-lg font-bold text-primary">₹${item.price.toFixed(2)}</span>
                    </div>
                    <p class="text-gray-600 mb-4">${item.category}</p>
                    <button onclick="addToCart('${item.id}')" class="w-full btn-primary py-2 rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Add to Cart
                    </button>
                </div>
            </div>
        `;
        menuGrid.innerHTML += menuItemHTML;
    }

    // --- Cart Functionality ---
    function updateCartBadge() {
        const badge = document.getElementById('cartBadge');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        badge.textContent = totalItems;
        badge.style.display = totalItems > 0 ? 'flex' : 'none';
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function addToCart(itemId) {
        if (!currentUser) {
            openLoginModal();
            return;
        }

        db.collection('menuItems').doc(itemId).get().then(doc => {
            if (doc.exists) {
                const itemData = doc.data();
                const item = { id: doc.id, ...itemData };

                const existingItemIndex = cart.findIndex(i => i.id === itemId);
                if (existingItemIndex > -1) {
                    cart[existingItemIndex].quantity += 1;
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                localStorage.setItem('mirdhunaCart', JSON.stringify(cart));
                updateCartBadge();
                showToast(`${item.name} added to cart!`);
            } else {
                showToast("Item not found.");
            }
        }).catch(error => {
            console.error("Error fetching item:", error);
            showToast("Could not add item.");
        });
    }

    // --- Menu Filtering ---
    function filterMenu(category) {
        const buttons = document.querySelectorAll('#menu .flex-wrap button');
        buttons.forEach(btn => {
            if (btn.textContent.trim() === (category === 'all' ? 'All Items' : category)) {
                btn.classList.add('bg-primary', 'text-white');
                btn.classList.remove('bg-light', 'text-dark', 'hover:bg-gray-200');
            } else {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-light', 'text-dark', 'hover:bg-gray-200');
            }
        });

        const items = document.querySelectorAll('#menuGrid > div');
        items.forEach(item => {
            const itemCategory = item.querySelector('p').textContent; // Assumes category is in the <p> tag
            if (category === 'all' || itemCategory === category) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // --- Simplified Login ---
    function openLoginModal() {
        document.getElementById('loginMessage').textContent = '';
        document.getElementById('userMobile').value = currentUser ? currentUser.mobile : '';
        document.getElementById('loginSpinner').style.display = 'none';
        document.getElementById('loginModal').style.display = 'block';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
    }

    function performLogin() {
        const mobile = document.getElementById('userMobile').value.trim();
        const spinner = document.getElementById('loginSpinner');
        const message = document.getElementById('loginMessage');

        if (!mobile) {
            message.textContent = 'Please enter a mobile number.';
            return;
        }
        // Basic validation (you might want more robust validation)
        if (mobile.length < 10 || isNaN(mobile)) {
             message.textContent = 'Please enter a valid mobile number.';
             return;
        }

        spinner.style.display = 'block';
        message.textContent = '';

        // --- Automatically detect location upon login ---
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    finishLogin(mobile, location);
                },
                (error) => {
                    console.warn("Location access denied or error:", error);
                    // Proceed with login even without location
                    finishLogin(mobile, null);
                    // Optionally, you could show a message or prompt again
                    // message.textContent = 'Location access denied. Proceeding without location.';
                    // spinner.style.display = 'none';
                }
            );
        } else {
            console.warn("Geolocation is not supported by this browser.");
            finishLogin(mobile, null); // Proceed without location
        }
    }

    function finishLogin(mobile, location) {
         const spinner = document.getElementById('loginSpinner');
         // Store user info (mobile and potentially location) in localStorage
         currentUser = { mobile: mobile, location: location };
         localStorage.setItem('mirdhunaUser', JSON.stringify(currentUser));
         console.log("User logged in:", currentUser);
         updateUIForLogin(); // Update UI elements
         spinner.style.display = 'none';
         closeLoginModal();
         showToast('Login successful!');
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('mirdhunaUser');
        // Optional: Clear cart on logout
        // cart = [];
        // localStorage.removeItem('mirdhunaCart');
        // updateCartBadge();
        updateUIForLogin();
        showToast('Logged out.');
    }

    function updateUIForLogin() {
        const loginButton = document.getElementById('loginButton');
        if (currentUser) {
            loginButton.innerHTML = '<i class="fas fa-user mr-2"></i> Logout';
            loginButton.onclick = logout;
        } else {
            loginButton.innerHTML = '<i class="fas fa-user mr-2"></i> Login';
            loginButton.onclick = openLoginModal;
        }
        updateCartBadge(); // Ensure badge reflects state
    }

    // --- Order Placement with WhatsApp ---
    function openOrderModal() {
        if (!currentUser) {
            openLoginModal();
            return;
        }
        if (cart.length === 0) {
            showToast("Your cart is empty!");
            return;
        }

        const orderDetails = document.getElementById('orderDetails');
        let detailsHTML = '<ul class="mb-4">';
        let totalPrice = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            totalPrice += itemTotal;
            detailsHTML += `<li class="flex justify-between py-1"><span>${item.name} x ${item.quantity}</span><span>₹${itemTotal.toFixed(2)}</span></li>`;
        });
        detailsHTML += `<li class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total:</span><span>₹${totalPrice.toFixed(2)}</span></li>`;
        detailsHTML += '</ul>';
        orderDetails.innerHTML = detailsHTML;

        document.getElementById('orderMessage').textContent = '';
        document.getElementById('orderSpinner').style.display = 'none';
        document.getElementById('orderModal').style.display = 'block';
    }

    function closeOrderModal() {
        document.getElementById('orderModal').style.display = 'none';
    }

    function placeOrder() {
        if (!currentUser || cart.length === 0) return;

        const spinner = document.getElementById('orderSpinner');
        const message = document.getElementById('orderMessage');
        spinner.style.display = 'block';
        message.textContent = '';

        // Ensure location is detected at time of order placement as well
        let locationToUse = currentUser.location; // Start with login location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Use the freshest location
                    locationToUse = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                     finalizeOrder(locationToUse);
                },
                (error) => {
                    console.warn("Location error during order placement:", error);
                    // Proceed with previously known location or none
                     finalizeOrder(locationToUse);
                }
            );
        } else {
             finalizeOrder(locationToUse); // Proceed with login location or none
        }
    }

    function finalizeOrder(location) {
        const spinner = document.getElementById('orderSpinner');
        const message = document.getElementById('orderMessage');

        const orderData = {
            userId: currentUser.mobile, // Using mobile as identifier
            items: cart,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'pending',
            location: location ? new firebase.firestore.GeoPoint(location.lat, location.lng) : null,
            userMobile: currentUser.mobile // Store mobile explicitly
        };

        db.collection('orders').add(orderData)
            .then(docRef => {
                console.log("Order placed with ID:", docRef.id);
                // --- WhatsApp Integration ---
                sendWhatsAppNotification(orderData);

                // Clear cart
                cart = [];
                localStorage.removeItem('mirdhunaCart');
                updateCartBadge();
                spinner.style.display = 'none';
                closeOrderModal();
                showToast('Order placed successfully!');
            })
            .catch(error => {
                console.error("Error placing order:", error);
                spinner.style.display = 'none';
                message.textContent = 'Failed to place order. Please try again.';
            });
    }

    function sendWhatsAppNotification(orderData) {
        // Admin WhatsApp Number
        const adminNumber = '9835124772'; // Your provided number
        // Format order details for WhatsApp message
        let messageBody = `*New Order from MIRDHUNA Cafe*\n\n`;
        messageBody += `*Customer Mobile:* ${orderData.userMobile}\n`;
        if (orderData.location) {
            messageBody += `*Location:* https://maps.google.com/?q=${orderData.location.latitude},${orderData.location.longitude}\n`;
        }
        messageBody += `\n*Order Items:*\n`;
        let total = 0;
        orderData.items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            messageBody += `- ${item.name} x ${item.quantity} = ₹${itemTotal.toFixed(2)}\n`;
        });
        messageBody += `\n*Total Amount:* ₹${total.toFixed(2)}\n`;
        messageBody += `\n*Status:* ${orderData.status}\n`;

        // Encode message for URL
        const encodedMessage = encodeURIComponent(messageBody);

        // Create WhatsApp links (these open the WhatsApp app/web if installed)
        const userLink = `https://wa.me/${orderData.userMobile}?text=${encodedMessage}`;
        const adminLink = `https://wa.me/${adminNumber}?text=${encodedMessage}`;

        // Open links in new tabs/windows
        // Note: Browsers might block multiple popups. Consider opening one or using a backend service.
        // window.open(userLink, '_blank');
        window.open(adminLink, '_blank');

        console.log("WhatsApp message prepared:", messageBody);
        console.log("Admin WhatsApp Link:", adminLink);
        // console.log("User WhatsApp Link:", userLink);
    }


    // --- Section Navigation ---
    function showSection(sectionId) {
        if (sectionId === 'menu') {
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
        }
        if (sectionId === 'contact') {
            document.getElementById('contact').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Close modals if clicked outside
    window.onclick = function(event) {
        if (event.target.id === 'loginModal') {
            closeLoginModal();
        }
        if (event.target.id === 'orderModal') {
            closeOrderModal();
        }
    }

    // --- Initialize ---
    window.onload = function() {
        updateUIForLogin(); // Set initial login button state
        updateCartBadge();
        loadMenu();
    };

  </script>

</body>
</html>
