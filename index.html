<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIRDHUNA | Premium Food Experience</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
  <!-- Firebase Auth (if needed for future features) -->
  <!-- <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script> -->
  <!-- Firebase Storage (if needed for future features) -->
  <!-- <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script> -->

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
      authDomain: "mirdhuna-25542.firebaseapp.com",
      databaseURL: "https://mirdhuna-25542-default-rtdb.firebaseio.com", // RTDB URL
      projectId: "mirdhuna-25542",
      storageBucket: "mirdhuna-25542.firebasestorage.app",
      messagingSenderId: "575924409876",
      appId: "1:575924409876:web:6ba1ed88ce941d9c83b901",
      measurementId: "G-YB7LDKHBPV"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    // Initialize Realtime Database
    const database = firebase.database();
    // const auth = firebase.auth(); // Not used in current simplified login
    // const storage = firebase.storage(); // Not used in current setup

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
            heading: ['Playfair Display', 'serif']
          },
          colors: {
            primary: '#e11d48',
            secondary: '#f43f5e',
            accent: '#f97316',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 3s infinite'
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Poppins', 'sans-serif';
      background: linear-gradient(135deg, #fff9f0 0%, #fff1f2 100%);
      overflow-x: hidden;
    }

    .hero-gradient {
      background: linear-gradient(135deg, rgba(225, 29, 72, 0.9) 0%, rgba(249, 115, 22, 0.85) 100%);
    }

    .menu-card {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .menu-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .btn-primary {
      background: linear-gradient(135deg, #e11d48 0%, #f97316 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(225, 29, 72, 0.4);
    }

    .history-item {
      border-left: 4px solid #e11d48;
      transition: all 0.3s ease;
    }

    .history-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-50px);
      transition: all 0.4s;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      font-weight: bold;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
    }

    .nav-item.active {
      color: #e11d48;
      font-weight: 600;
      position: relative;
    }

    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: #e11d48;
      border-radius: 3px;
    }

    .floating-element {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .two-col-grid {
      /* Ensures 2 items per row on all screen sizes */
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    /* Loading Spinner */
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #e11d48;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none; /* Hidden by default */
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* --- Add these CSS rules for colorful social icons --- */
    .social-facebook:hover {
        background-color: #1877f2; /* Facebook Blue */
        color: white;
    }
    .social-instagram:hover {
        background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); /* Instagram Gradient */
        color: white;
    }
    .social-whatsapp:hover {
        background-color: #25d366; /* WhatsApp Green */
        color: white;
    }
    .social-telegram:hover {
        background-color: #0088cc; /* Telegram Blue */
        color: white;
    }
    /* --- End of Social Icon Colors --- */


  </style>
</head>
<body class="min-h-screen">

  <!-- Toast Notification -->
  <div id="toast" class="toast">Item added to cart!</div>

  <!-- Login Modal -->
<div id="loginModal" class="modal hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center">
  <div class="modal-content glass-card rounded-lg p-6 w-11/12 max-w-md">
    <span class="close absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer text-2xl" onclick="closeLoginModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <input type="text" id="userMobile" placeholder="Enter your mobile number (e.g., 9835124772)" class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
    <button onclick="performLogin()" class="btn-primary w-full px-4 py-3 rounded-lg font-bold text-lg">Login</button>
    <div id="loginSpinner" class="spinner mt-4"></div>
    <p id="loginMessage" class="text-red-500 text-center mt-2"></p>
  </div>
</div>

 <!-- Order Confirmation Modal -->
<div id="orderModal" class="modal hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center">
  <div class="modal-content glass-card rounded-lg p-6 w-11/12 max-w-md">
    <span class="close absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer text-2xl" onclick="closeOrderModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-4 text-center">Confirm Order</h2>
    <div id="orderDetails"></div>
    <p class="mt-4 text-sm text-gray-600"><i class="fas fa-info-circle mr-2"></i> Your location was detected during login.</p>
    <button onclick="placeOrder()" class="btn-primary w-full mt-4 px-4 py-3 rounded-lg font-bold text-lg">Place Order</button>
    <div id="orderSpinner" class="spinner mt-4"></div>
    <p id="orderMessage" class="text-red-500 text-center mt-2"></p>
  </div>
</div>

<!-- Order History Modal -->
<div id="orderHistoryModal" class="modal hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center">
  <div class="modal-content glass-card rounded-lg p-6 w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto">
    <span class="close absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer text-2xl" onclick="closeOrderHistoryModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-4 text-center">Your Order History</h2>
    <div id="orderHistoryList">
      <!-- Orders will be loaded here -->
      <div id="orderHistorySpinner" class="spinner" style="display:block;"></div>
      <p id="orderHistoryMessage" class="text-center text-gray-500"></p>
    </div>
  </div>
</div>


  <!-- Header -->
  <header class="hero-gradient text-white py-16 px-4 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10">
      <div class="absolute top-10 left-10 w-64 h-64 bg-white rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob"></div>
      <div class="absolute top-10 right-10 w-64 h-64 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-2000"></div>
      <div class="absolute bottom-10 left-1/2 w-64 h-64 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Floating food elements -->
    <div class="absolute bottom-20 left-10 floating-element">
      <div class="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-pizza-slice text-white text-2xl"></i>
      </div>
    </div>
    <div class="absolute top-24 right-20 floating-element animation-delay-1000">
      <div class="w-12 h-12 bg-red-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-hamburger text-white text-xl"></i>
      </div>
    </div>
    <div class="absolute top-1/3 left-1/4 floating-element animation-delay-2000">
      <div class="w-10 h-10 bg-green-400 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-martini-glass text-white"></i>
      </div>
    </div>

    <div class="container mx-auto relative z-10 text-center">
      <h1 class="text-5xl md:text-7xl font-heading font-bold mb-4 tracking-tight">MIRDHUNA</h1>
      <p class="text-xl md:text-2xl mb-8 max-w-2xl mx-auto">Experience Culinary Excellence with Every Bite</p>
      <div class="flex flex-wrap justify-center gap-4">
        <button onclick="showSection('menu')" class="btn-primary px-8 py-3 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all">
          <i class="fas fa-utensils mr-2"></i> Order Now
        </button>
        <button onclick="openLoginModal()" id="loginButton" class="bg-white bg-opacity-20 backdrop-blur-sm px-8 py-3 rounded-full font-bold text-lg hover:bg-opacity-30 transition-all">
          <i class="fas fa-user mr-2"></i> Login
        </button>
         <!-- Cart Icon with Badge -->
        <div class="relative">
            <button onclick="openOrderModal()" class="bg-white bg-opacity-20 backdrop-blur-sm p-3 rounded-full hover:bg-opacity-30 transition-all">
                <i class="fas fa-shopping-cart text-xl"></i>
                 <span id="cartBadge" class="cart-badge">0</span>
            </button>
        </div>
         <!-- Order History Icon -->
        <div>
            <button onclick="openOrderHistoryModal()" class="bg-white bg-opacity-20 backdrop-blur-sm p-3 rounded-full hover:bg-opacity-30 transition-all">
                <i class="fas fa-history text-xl"></i>
            </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Menu Section (Still uses Firestore for menu items) -->
  <section id="menu" class="py-16 px-4">
    <div class="container mx-auto">
      <h2 class="text-4xl font-heading font-bold text-center mb-12 text-dark">Our Delicious Menu</h2>

      <!-- Menu Categories -->
      <div class="mb-12">
        <div class="flex flex-wrap justify-center gap-4 mb-8">
          <button onclick="filterMenu('all')" class="px-6 py-2 rounded-full bg-primary text-white font-medium hover:bg-secondary transition-colors active-category">All Items</button>
          <button onclick="filterMenu('Pizza')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Pizza</button>
          <button onclick="filterMenu('Burger')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Burger</button>
          <button onclick="filterMenu('Sandwich')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Sandwich</button>
          <button onclick="filterMenu('Shakes')" class="px-6 py-2 rounded-full bg-light text-dark font-medium hover:bg-gray-200 transition-colors">Shakes</button>
        </div>

        <!-- Menu Items Grid -->
        <div id="menuGrid" class="two-col-grid">
          <!-- Menu items will be dynamically inserted here -->
        </div>
         <div id="menuSpinner" class="spinner"></div>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
<section id="contact" class="py-16 px-4 bg-light">
  <div class="container mx-auto">
    <h2 class="text-4xl font-heading font-bold text-center mb-12 text-dark">Visit Us</h2>
    <div class="flex flex-col md:flex-row items-center justify-center gap-12">
      <div class="text-center md:text-left">
        <h3 class="text-2xl font-bold mb-4 text-dark">MIRDHUNA Cafe</h3>
        <p class="mb-2 flex items-center justify-center md:justify-start">
          <i class="fas fa-map-marker-alt mr-3 text-primary"></i>
          <a href="https://maps.app.goo.gl/kotovw4g7chuqy5J8" target="_blank" class="hover:text-primary transition-colors">
              Find us on Google Maps
          </a>
        </p>
        <p class="mb-2 flex items-center justify-center md:justify-start">
          <i class="fas fa-phone mr-3 text-primary"></i>
          <a href="tel:9835124772" class="hover:text-primary transition-colors">9835124772</a>
        </p>
        <p class="flex items-center justify-center md:justify-start">
          <i class="fab fa-whatsapp mr-3 text-primary"></i>
          <a href="https://wa.me/9835124772" target="_blank" class="hover:text-primary transition-colors">WhatsApp Us</a>
        </p>
      </div>
       <div class="w-full md:w-1/2 h-64 md:h-80 rounded-xl overflow-hidden shadow-lg">
        <!-- Corrected Map Embed using the provided link -->
        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3759.109650774896!2d75.76771427510262!3d19.99745802334703!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bddeb44b491e88f%3A0x6c747e368e1b758b!2sMirdhuna%20Cafe!5e0!3m2!1sen!2sin!5m2!1sen!2sin" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>
</section>

  <!-- Footer -->
  <footer class="bg-dark text-white py-8 px-4">
    <div class="container mx-auto text-center">
      <p>&copy; 2024 MIRDHUNA Cafe. All rights reserved.</p>
      <!-- Social Media Icons in 2x2 Grid (Updated for Color) -->
      <div class="mt-6 grid grid-cols-2 gap-4 max-w-xs mx-auto">
        <a href="https://www.facebook.com/yourpage" target="_blank" class="bg-gray-800 hover:bg-primary p-3 rounded-lg flex items-center justify-center transition-colors social-facebook">
          <i class="fab fa-facebook-f text-2xl"></i>
        </a>
        <a href="https://www.instagram.com/yourprofile" target="_blank" class="bg-gray-800 hover:bg-primary p-3 rounded-lg flex items-center justify-center transition-colors social-instagram">
          <i class="fab fa-instagram text-2xl"></i>
        </a>
        <a href="https://wa.me/9835124772" target="_blank" class="bg-gray-800 hover:bg-primary p-3 rounded-lg flex items-center justify-center transition-colors social-whatsapp">
          <i class="fab fa-whatsapp text-2xl"></i>
        </a>
        <a href="https://t.me/yourusername" target="_blank" class="bg-gray-800 hover:bg-primary p-3 rounded-lg flex items-center justify-center transition-colors social-telegram">
          <i class="fab fa-telegram-plane text-2xl"></i>
        </a>
      </div>
    </div>
  </footer>

  <script>
    // --- State Management ---
    let cart = JSON.parse(localStorage.getItem('mirdhunaCart')) || [];
    let currentUser = JSON.parse(localStorage.getItem('mirdhunaUser')) || null; // { mobile: '...', location: { lat, lng } }

    // --- Firestore Menu Listener (Menu still comes from Firestore) ---
    function loadMenu() {
        const spinner = document.getElementById('menuSpinner');
        spinner.style.display = 'block';
        const menuGrid = document.getElementById('menuGrid');
        menuGrid.innerHTML = '';

        // Using Firestore for menu items (as before)
        const db = firebase.firestore();
        db.collection('menuItems')
            .orderBy('category')
            .onSnapshot(snapshot => {
                spinner.style.display = 'none';
                menuGrid.innerHTML = '';
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" || change.type === "modified") {
                        const item = { id: change.doc.id, ...change.doc.data() };
                        renderMenuItem(item);
                    }
                    if (change.type === "removed") {
                        const itemElement = document.getElementById(`item-${change.doc.id}`);
                        if(itemElement) itemElement.remove();
                    }
                });
                filterMenu('all'); // Initially show all items
            }, error => {
                spinner.style.display = 'none';
                console.error("Error loading menu from Firestore:", error);
                showToast("Failed to load menu.");
            });
    }

    function renderMenuItem(item) {
        const menuGrid = document.getElementById('menuGrid');
        const menuItemHTML = `
            <div id="item-${item.id}" class="menu-card bg-white rounded-xl overflow-hidden shadow-md hover:shadow-xl">
                <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${item.name}" class="w-full h-48 object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Error';">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-dark">${item.name}</h3>
                        <span class="text-lg font-bold text-primary">₹${item.price.toFixed(2)}</span>
                    </div>
                    <p class="text-gray-600 mb-4">${item.category}</p>
                    <button onclick="addToCart('${item.id}')" class="w-full btn-primary py-2 rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Add to Cart
                    </button>
                </div>
            </div>
        `;
        menuGrid.innerHTML += menuItemHTML;
    }

    // --- Cart Functionality ---
    function updateCartBadge() {
        const badge = document.getElementById('cartBadge');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        badge.textContent = totalItems;
        badge.style.display = totalItems > 0 ? 'flex' : 'none';
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function addToCart(itemId) {
        if (!currentUser) {
            openLoginModal();
            return;
        }

        // Using Firestore to fetch item details
        const db = firebase.firestore();
        db.collection('menuItems').doc(itemId).get().then(doc => {
            if (doc.exists) {
                const itemData = doc.data();
                const item = { id: doc.id, ...itemData };

                const existingItemIndex = cart.findIndex(i => i.id === itemId);
                if (existingItemIndex > -1) {
                    cart[existingItemIndex].quantity += 1;
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                localStorage.setItem('mirdhunaCart', JSON.stringify(cart));
                updateCartBadge();
                showToast(`${item.name} added to cart!`);
            } else {
                showToast("Item not found.");
            }
        }).catch(error => {
            console.error("Error fetching item from Firestore:", error);
            showToast("Could not add item.");
        });
    }

    // --- Menu Filtering (for Firestore menu) ---
    function filterMenu(category) {
        const buttons = document.querySelectorAll('#menu .flex-wrap button');
        buttons.forEach(btn => {
            if (btn.textContent.trim() === (category === 'all' ? 'All Items' : category)) {
                btn.classList.add('bg-primary', 'text-white');
                btn.classList.remove('bg-light', 'text-dark', 'hover:bg-gray-200');
            } else {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-light', 'text-dark', 'hover:bg-gray-200');
            }
        });

        const items = document.querySelectorAll('#menuGrid > div');
        items.forEach(item => {
            const itemCategory = item.querySelector('p').textContent; // Assumes category is in the <p> tag
            if (category === 'all' || itemCategory === category) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // --- Simplified Login with Location (Unchanged) ---
    function openLoginModal() {
        document.getElementById('loginMessage').textContent = '';
        document.getElementById('userMobile').value = currentUser ? currentUser.mobile : '';
        document.getElementById('loginSpinner').style.display = 'none';
        document.getElementById('loginModal').classList.remove('hidden'); // Show modal
    }

    function closeLoginModal() {
        document.getElementById('loginModal').classList.add('hidden'); // Hide modal
    }

    function performLogin() {
        const mobile = document.getElementById('userMobile').value.trim();
        const spinner = document.getElementById('loginSpinner');
        const message = document.getElementById('loginMessage');

        if (!mobile) {
            message.textContent = 'Please enter a mobile number.';
            return;
        }
        if (mobile.length < 10 || isNaN(mobile)) {
             message.textContent = 'Please enter a valid mobile number.';
             return;
        }

        spinner.style.display = 'block';
        message.textContent = '';

        console.log("Requesting location for user:", mobile);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("Location obtained:", location);
                    finishLogin(mobile, location);
                },
                (error) => {
                    console.warn("Location access denied or error:", error);
                    finishLogin(mobile, null); // Login without location
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        } else {
            console.warn("Geolocation is not supported by this browser.");
            finishLogin(mobile, null);
            message.textContent = 'Location not supported, but login proceeding.';
        }
    }

    function finishLogin(mobile, location) {
         const spinner = document.getElementById('loginSpinner');
         currentUser = { mobile: mobile, location: location };
         localStorage.setItem('mirdhunaUser', JSON.stringify(currentUser));
         console.log("User logged in:", currentUser);
         updateUIForLogin();
         spinner.style.display = 'none';
         closeLoginModal();
         showToast('Login successful!');
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('mirdhunaUser');
        updateUIForLogin();
        showToast('Logged out.');
    }

    function updateUIForLogin() {
        const loginButton = document.getElementById('loginButton');
        if (currentUser) {
            loginButton.innerHTML = '<i class="fas fa-user mr-2"></i> Logout';
            loginButton.onclick = logout;
        } else {
            loginButton.innerHTML = '<i class="fas fa-user mr-2"></i> Login';
            loginButton.onclick = openLoginModal;
        }
        updateCartBadge();
    }

    // --- Order Placement (Now uses Realtime Database, no location in order data) ---
    function openOrderModal() {
        if (!currentUser) {
            openLoginModal();
            return;
        }
        if (cart.length === 0) {
            showToast("Your cart is empty!");
            return;
        }

        const orderDetails = document.getElementById('orderDetails');
        let detailsHTML = '<ul class="mb-4">';
        let totalPrice = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            totalPrice += itemTotal;
            detailsHTML += `<li class="flex justify-between py-1"><span>${item.name} x ${item.quantity}</span><span>₹${itemTotal.toFixed(2)}</span></li>`;
        });
        detailsHTML += `<li class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total:</span><span>₹${totalPrice.toFixed(2)}</span></li>`;
        detailsHTML += '</ul>';
        orderDetails.innerHTML = detailsHTML;

        document.getElementById('orderMessage').textContent = '';
        document.getElementById('orderSpinner').style.display = 'none';
        document.getElementById('orderModal').classList.remove('hidden');
    }

    function closeOrderModal() {
        document.getElementById('orderModal').classList.add('hidden');
    }

    function placeOrder() {
        if (!currentUser) {
            openLoginModal();
            return;
        }
        if (cart.length === 0) {
            showToast("Your cart is empty!");
            return;
        }

        const spinner = document.getElementById('orderSpinner');
        const message = document.getElementById('orderMessage');
        spinner.style.display = 'block';
        message.textContent = '';

        // Proceed directly to finalize the order (location not requested here)
        finalizeOrder();
    }

    function finalizeOrder() {
        const spinner = document.getElementById('orderSpinner');
        const message = document.getElementById('orderMessage');

        if (!currentUser || !cart || cart.length === 0) {
            console.error("Order placement failed: Invalid state");
            spinner.style.display = 'none';
            message.textContent = 'Order failed: Invalid state. Please try again.';
            return;
        }

        // Prepare order data for Realtime Database (NO location field)
        const orderData = {
            userId: currentUser.mobile,
            items: cart,
            // timestamp: firebase.database.ServerValue.TIMESTAMP, // Use RTDB server timestamp
            timestamp: { '.sv': 'timestamp' }, // Alternative syntax for ServerValue.TIMESTAMP
            status: 'pending',
            userMobile: currentUser.mobile
            // location: ... is intentionally omitted
        };

        console.log("Attempting to save order to Realtime Database:", orderData);

        // Get a reference to the 'orders' node in RTDB
        const ordersRef = database.ref('orders');

        // Push the new order data (generates a unique key)
        const newOrderRef = ordersRef.push(orderData);

        newOrderRef.then(() => {
             console.log("Order placed successfully with key:", newOrderRef.key);
             // Clear cart on success
             cart = [];
             localStorage.removeItem('mirdhunaCart');
             updateCartBadge();
             spinner.style.display = 'none';
             closeOrderModal();
             showToast('Order placed successfully!');
         })
         .catch((error) => {
             console.error("Critical Error placing order in RTDB:", error);
             spinner.style.display = 'none';
             message.textContent = 'Failed to place order. Please try again. (Error: ' + (error.message || 'Unknown') + ')';
         });
    }


    // --- Order History (Now uses Realtime Database) ---
    let orderHistoryUnsubscribe = null; // To hold the RTDB listener

    function openOrderHistoryModal() {
        if (!currentUser) {
            openLoginModal();
            return;
        }

        const list = document.getElementById('orderHistoryList');
        const spinner = document.getElementById('orderHistorySpinner');
        const message = document.getElementById('orderHistoryMessage');

        list.innerHTML = '';
        spinner.style.display = 'block';
        message.textContent = '';
        document.getElementById('orderHistoryModal').classList.remove('hidden');

        // Close any existing listener to prevent duplicates
        if (orderHistoryUnsubscribe) {
            orderHistoryUnsubscribe();
            orderHistoryUnsubscribe = null;
        }

        // Get a reference to the 'orders' node in RTDB
        const ordersRef = database.ref('orders');

        // Set up a real-time listener for all orders
        orderHistoryUnsubscribe = ordersRef.on('value', (snapshot) => {
            spinner.style.display = 'none';
            list.innerHTML = ''; // Clear previous content

            if (!snapshot.exists()) {
                message.textContent = 'No orders found.';
                return;
            }

            const allOrders = snapshot.val();
            const userOrders = [];

            // Filter orders client-side by userMobile
            for (const orderId in allOrders) {
                if (allOrders[orderId].userMobile === currentUser.mobile) {
                    userOrders.push({ id: orderId, ...allOrders[orderId] });
                }
            }

            if (userOrders.length === 0) {
                message.textContent = 'No orders found.';
                return;
            }

            // Sort orders by timestamp (newest first) - assuming timestamp is numeric
            userOrders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            userOrders.forEach(order => {
                const orderId = order.id;
                // Timestamp might be an object from ServerValue, or a number
                const timestampRaw = order.timestamp;
                let timestampDisplay = 'N/A';
                if (typeof timestampRaw === 'number') {
                    timestampDisplay = new Date(timestampRaw).toLocaleString();
                } else if (timestampRaw && typeof timestampRaw === 'object' && timestampRaw['.sv'] === 'timestamp') {
                    // This was the placeholder, actual timestamp will be a number when retrieved
                    timestampDisplay = 'Just now';
                } else if (timestampRaw) {
                     // If it's already a date string or object, try to format it
                     try {
                         timestampDisplay = new Date(timestampRaw).toLocaleString();
                     } catch (e) {
                         timestampDisplay = String(timestampRaw);
                     }
                }

                const orderElement = document.createElement('div');
                orderElement.className = 'history-item bg-white rounded-lg p-4 mb-4 shadow';

                let itemsHtml = '<ul class="mb-2">';
                let total = 0;
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                         const itemTotal = item.price * item.quantity;
                         total += itemTotal;
                         itemsHtml += `<li class="text-sm">${item.name} x ${item.quantity} = ₹${itemTotal.toFixed(2)}</li>`;
                    });
                } else {
                    itemsHtml += '<li class="text-sm">No items found</li>';
                }
                itemsHtml += '</ul>';

                orderElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold">Order ID: ${orderId.substring(0, 6)}...</h3>
                        <span class="text-sm text-gray-500">${timestampDisplay}</span>
                    </div>
                    ${itemsHtml}
                    <div class="flex justify-between font-semibold">
                        <span>Total:</span>
                        <span>₹${total.toFixed(2)}</span>
                    </div>
                    <div class="mt-2 text-sm">
                        <span class="inline-block px-2 py-1 rounded ${
                            order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            order.status === 'preparing' ? 'bg-blue-100 text-blue-800' :
                            order.status === 'ready' ? 'bg-green-100 text-green-800' :
                            order.status === 'delivered' ? 'bg-gray-100 text-gray-800' : 'bg-gray-100 text-gray-800'
                        }">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                    </div>
                `;
                list.appendChild(orderElement);
            });

        }, (error) => {
            spinner.style.display = 'none';
            console.error("Error loading order history from RTDB:", error);
            message.textContent = 'Failed to load order history.';
        });
    }

    function closeOrderHistoryModal() {
        document.getElementById('orderHistoryModal').classList.add('hidden');
        // Unsubscribe from the RTDB listener when closing the modal
        if (orderHistoryUnsubscribe) {
            const ordersRef = database.ref('orders');
            ordersRef.off('value', orderHistoryUnsubscribe);
            orderHistoryUnsubscribe = null;
        }
    }


    // --- Section Navigation ---
    function showSection(sectionId) {
        if (sectionId === 'menu') {
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
        }
        if (sectionId === 'contact') {
            document.getElementById('contact').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Close modals if clicked outside
    window.onclick = function(event) {
        if (event.target.id === 'loginModal') {
            closeLoginModal();
        }
        if (event.target.id === 'orderModal') {
            closeOrderModal();
        }
        if (event.target.id === 'orderHistoryModal') {
             closeOrderHistoryModal();
        }
    }

    // --- Initialize ---
    window.onload = function() {
        updateUIForLogin();
        updateCartBadge();
        loadMenu();
    };

  </script>

</body>
</html>
